var ue=Object.defineProperty;var pe=(e,t)=>{for(var r in t)ue(e,r,{get:t[r],enumerable:!0})};var a={};pe(a,{Parser:()=>U,all:()=>Ar,choice:()=>de,eof:()=>gr,fail:()=>fe,lazy:()=>he,location:()=>Zt,match:()=>le,ok:()=>ct,text:()=>me});var U=class Q{constructor(t){this.action=t}parse(t){let r={index:0,line:1,column:1},n=new ge({input:t,location:r}),o=this.skip(gr).action(n);return o.type==="ActionOK"?{type:"ParseOK",value:o.value}:{type:"ParseFail",location:o.furthest,expected:o.expected}}tryParse(t){let r=this.parse(t);if(r.type==="ParseOK")return r.value;let{expected:n,location:o}=r,{line:i,column:c}=o,p=`parse error at line ${i} column ${c}: expected ${n.join(", ")}`;throw new Error(p)}and(t){return new Q(r=>{let n=this.action(r);if(n.type==="ActionFail")return n;r=r.moveTo(n.location);let o=r.merge(n,t.action(r));if(o.type==="ActionOK"){let i=[n.value,o.value];return r.merge(o,r.ok(o.location.index,i))}return o})}skip(t){return this.and(t).map(([r])=>r)}next(t){return this.and(t).map(([,r])=>r)}or(t){return new Q(r=>{let n=this.action(r);return n.type==="ActionOK"?n:r.merge(n,t.action(r))})}chain(t){return new Q(r=>{let n=this.action(r);if(n.type==="ActionFail")return n;let o=t(n.value);return r=r.moveTo(n.location),r.merge(n,o.action(r))})}map(t){return this.chain(r=>ct(t(r)))}thru(t){return t(this)}desc(t){return new Q(r=>{let n=this.action(r);return n.type==="ActionOK"?n:{type:"ActionFail",furthest:n.furthest,expected:t}})}wrap(t,r){return t.next(this).skip(r)}trim(t){return this.wrap(t,t)}repeat(t=0,r=1/0){if(!xr(t,r))throw new Error(`repeat: bad range (${t} to ${r})`);return t===0?this.repeat(1,r).or(ct([])):new Q(n=>{let o=[],i=this.action(n);if(i.type==="ActionFail")return i;for(;i.type==="ActionOK"&&o.length<r;){if(o.push(i.value),i.location.index===n.location.index)throw new Error("infinite loop detected; don't call .repeat() with parsers that can accept zero characters");n=n.moveTo(i.location),i=n.merge(i,this.action(n))}return i.type==="ActionFail"&&o.length<t?i:n.merge(i,n.ok(n.location.index,o))})}sepBy(t,r=0,n=1/0){if(!xr(r,n))throw new Error(`sepBy: bad range (${r} to ${n})`);return r===0?this.sepBy(t,1,n).or(ct([])):n===1?this.map(o=>[o]):this.chain(o=>t.next(this).repeat(r-1,n-1).map(i=>[o,...i]))}node(t){return Ar(Zt,this,Zt).map(([r,n,o])=>({type:"ParseNode",name:t,value:n,start:r,end:o}))}};function xr(e,t){return e<=t&&e>=0&&t>=0&&Number.isInteger(e)&&e!==1/0&&(Number.isInteger(t)||t===1/0)}var Zt=new U(e=>e.ok(e.location.index,e.location));function ct(e){return new U(t=>t.ok(t.location.index,e))}function fe(e){return new U(t=>t.fail(t.location.index,e))}var gr=new U(e=>e.location.index<e.input.length?e.fail(e.location.index,["<EOF>"]):e.ok(e.location.index,"<EOF>"));function me(e){return new U(t=>{let r=t.location.index,n=r+e.length;return t.input.slice(r,n)===e?t.ok(n,e):t.fail(r,[e])})}function le(e){for(let r of e.flags)switch(r){case"i":case"s":case"m":case"u":continue;default:throw new Error("only the regexp flags 'imsu' are supported")}let t=new RegExp(e.source,e.flags+"y");return new U(r=>{let n=r.location.index;t.lastIndex=n;let o=r.input.match(t);if(o){let i=n+o[0].length,c=r.input.slice(n,i);return r.ok(i,c)}return r.fail(n,[String(e)])})}function Ar(...e){return e.reduce((t,r)=>t.chain(n=>r.map(o=>[...n,o])),ct([]))}function de(...e){return e.reduce((t,r)=>t.or(r))}function he(e){let t=new U(r=>(t.action=e().action,t.action(r)));return t}function xe(e,t){return[...new Set([...e,...t])]}var ge=class br{constructor(t){this.input=t.input,this.location=t.location}moveTo(t){return new br({input:this.input,location:t})}_internal_move(t){if(t===this.location.index)return this.location;let r=this.location.index,n=t,o=this.input.slice(r,n),{line:i,column:c}=this.location;for(let p of o)p===`
`?(i++,c=1):c++;return{index:t,line:i,column:c}}ok(t,r){return{type:"ActionOK",value:r,location:this._internal_move(t),furthest:{index:-1,line:-1,column:-1},expected:[]}}fail(t,r){return{type:"ActionFail",furthest:this._internal_move(t),expected:r}}merge(t,r){if(r.furthest.index>t.furthest.index)return r;let n=r.furthest.index===t.furthest.index?xe(t.expected,r.expected):t.expected;return r.type==="ActionOK"?{type:"ActionOK",location:r.location,value:r.value,furthest:t.furthest,expected:n}:{type:"ActionFail",furthest:t.furthest,expected:n}}};var m=class{pretty(){return""}doesReturnValue(){return!1}isSameComponent(t){return!0}};var zt="A1",Ut="B0",kt="B1",Er="ADD";function Ae(e){switch(e){case 0:return zt;case 1:return Ut;case 2:return kt}}function be(e){switch(e){case zt:return 0;case Ut:return 1;case kt:return 2}}var D=class extends m{constructor(t){super(),this.op=t}pretty(){return`${Er} ${Ae(this.op)}`}static parse(t){let r=t.trim().split(/\s+/u);if(r.length!==2)return;let[n,o]=r;if(n===Er&&(o===zt||o===Ut||o===kt))return new D(be(o))}doesReturnValue(){switch(this.op){case 0:return!1;case 1:return!0;case 2:return!0}}isSameComponent(t){return t instanceof D}};var Pt="INC",Ft="TDEC",wt="READ",Gt="SET",Wt="B2DX",Vt="B2DY",Yt="B2D",Ee="DEC",yr="SQX",Sr="SQY",Pr="SQ";function wr(e){switch(e){case Pt:return 0;case Ft:return 1;case wt:return 2;case Gt:return 3}}function ye(e){switch(e){case 0:return Pt;case 1:return Ft;case 2:return wt;case 3:return Gt}}function Gr(e){switch(e){case Wt:return 4;case Vt:return 5;case Yt:return 6}}function Se(e){switch(e){case 4:return Wt;case 5:return Vt;case 6:return Yt}}var A=class extends m{constructor(t,r){super(),this.op=t,this.axis=r}pretty(){return`${ye(this.op)} ${Se(this.axis)}`}static parse(t){let r=t.trim().split(/\s+/u);if(r.length!==2)return;let[n,o]=r;if(!(n===void 0||o===void 0)){if(n===Pt||n===Ft){if(o===Wt||o===Vt)return new A(wr(n),Gr(o))}else if((n===wt||n===Gt)&&o===Yt)return new A(wr(n),Gr(o));switch(n){case Pt:switch(o){case yr:return new A(0,4);case Sr:return new A(0,5);default:return}case Ee:switch(o){case yr:return new A(1,4);case Sr:return new A(1,5);default:return}case wt:switch(o){case Pr:return new A(2,6);default:return}case Gt:switch(o){case Pr:return new A(3,6);default:return}}}}doesReturnValue(){switch(this.op){case 0:return!1;case 1:return!0;case 2:return!0;case 3:return!1}}isSameComponent(t){if(t instanceof A){let r=this.axis,n=t.axis;return r===4&&n===5?!1:!(r===5&&n===4)}return!1}};var Ht="INC",Xt="TDEC",jt="READ",qt="SET",Nr="B";function Pe(e){switch(e){case 0:return Ht;case 1:return Xt;case 2:return jt;case 3:return qt}}function we(e){switch(e){case Ht:return 0;case Xt:return 1;case jt:return 2;case qt:return 3}}var w=class extends m{constructor(t,r){super(),this.op=t,this.regNumber=r,this.registerCache=void 0}pretty(){return`${Pe(this.op)} ${Nr}${this.regNumber}`}static parse(t){let r=t.trim().split(/\s+/u);if(r.length!==2)return;let[n,o]=r;if(!(n===void 0||o===void 0)&&(n===Ht||n===Xt||n===jt||n===qt)&&o.startsWith(Nr)){let i=o.slice(1);if(/^[0-9]+$/u.test(i))return new w(we(n),parseInt(i,10))}}doesReturnValue(){switch(this.op){case 0:return!1;case 1:return!0;case 2:return!0;case 3:return!1}}isSameComponent(t){return t instanceof w?this.regNumber===t.regNumber:!1}};var Mr="HALT_OUT",x=class extends m{constructor(){super()}pretty(){return Mr}static parse(t){let r=t.trim().split(/\s+/u);if(r.length!==1)return;let[n]=r;if(n===Mr)return new x}doesReturnValue(){return!1}isSameComponent(t){return t instanceof x}};var Qt="0",tr="1",Br="MUL";function Ge(e){switch(e){case Qt:return 0;case tr:return 1}}function Ne(e){switch(e){case 0:return Qt;case 1:return tr}}var k=class extends m{constructor(t){super(),this.op=t}pretty(){return`${Br} ${Ne(this.op)}`}static parse(t){let r=t.trim().split(/\s+/u);if(r.length!==2)return;let[n,o]=r;if(n===Br&&(o===Qt||o===tr))return new k(Ge(o))}doesReturnValue(){return!0}isSameComponent(t){return t instanceof k}};var Lr="NOP",b=class extends m{constructor(){super()}pretty(){return Lr}static parse(t){let r=t.trim().split(/\s+/u);if(r.length!==1)return;let[n]=r;if(n===Lr)return new b}doesReturnValue(){return!0}isSameComponent(t){return t instanceof b}};var Tr="OUTPUT",F=class extends m{constructor(t){super(),this.digit=t}pretty(){return`${Tr} ${this.digit}`}static parse(t){let r=t.trim().split(/\s+/u);if(r.length!==2)return;let[n,o]=r;if(n===Tr&&o!==void 0)return new F(o)}doesReturnValue(){return!1}isSameComponent(t){return t instanceof F}};var rr="A1",er="B0",nr="B1",Rr="SUB";function Me(e){switch(e){case 0:return rr;case 1:return er;case 2:return nr}}function Be(e){switch(e){case rr:return 0;case er:return 1;case nr:return 2}}var W=class extends m{constructor(t){super(),this.op=t}pretty(){return`${Rr} ${Me(this.op)}`}static parse(t){let r=t.trim().split(/\s+/u);if(r.length!==2)return;let[n,o]=r;if(n===Rr&&(o===rr||o===er||o===nr))return new W(Be(o))}doesReturnValue(){switch(this.op){case 0:return!1;case 1:return!0;case 2:return!0}}isSameComponent(t){return t instanceof W}};var or="INC",ir="TDEC",$r="U",Le="R";function Te(e){switch(e){case 0:return or;case 1:return ir}}function Re(e){switch(e){case or:return 0;case ir:return 1}}var G=class extends m{constructor(t,r){super(),this.op=t,this.regNumber=r,this.registerCache=void 0}pretty(){return`${Te(this.op)} ${$r}${this.regNumber}`}static parse(t){let r=t.trim().split(/\s+/u);if(r.length!==2)return;let[n,o]=r;if(!(n===void 0||o===void 0)&&(n===or||n===ir)&&(o.startsWith($r)||o.startsWith(Le))){let i=o.slice(1);if(/^[0-9]+$/u.test(i))return new G(Re(n),parseInt(i,10))}}doesReturnValue(){switch(this.op){case 0:return!1;case 1:return!0}}isSameComponent(t){return t instanceof G?this.regNumber===t.regNumber:!1}};var sr="INC",ar="DEC",cr="READ",ur="SET",pr="RESET";function $e(e){switch(e){case 0:return sr;case 1:return ar;case 2:return cr;case 3:return ur;case 4:return pr}}function ve(e){switch(e){case sr:return 0;case ar:return 1;case cr:return 2;case ur:return 3;case pr:return 4}}var _=class extends m{constructor(t,r){super(),this.op=t,this.regNumber=r}pretty(){return`${$e(this.op)} T${this.regNumber}`}static parse(t){let r=t.trim().split(/\s+/u);if(r.length!==2)return;let[n,o]=r;if(!(n===void 0||o===void 0)&&(n===sr||n===ar||n===cr||n===ur||n===pr)&&o.startsWith("T")){let i=o.slice(1);if(/^[0-9]+$/u.test(i))return new _(ve(n),parseInt(i,10))}}doesReturnValue(){switch(this.op){case 0:return!0;case 1:return!0;case 2:return!0;case 3:return!1;case 4:return!1}}isSameComponent(t){return t instanceof _?this.regNumber===t.regNumber:!1}};function et(e){let t=[w.parse,G.parse,A.parse,b.parse,D.parse,k.parse,W.parse,F.parse,x.parse,_.parse];for(let r of t){let n=r(e);if(n!==void 0)return n}}var ts=Number.parseInt,rs=Number.isNaN;var _e=a.match(/[0-9]+/).desc(["number"]).map(e=>({raw:e,value:parseInt(e,10)})),Oe=a.match(/0x[a-fA-F0-9]+/).desc(["hexadecimal number"]).map(e=>({raw:e,value:parseInt(e,16)})),vr=Oe.or(_e).desc(["number"]);var h=class{constructor(){}},f=class extends Error{constructor(r,n,o){super(r,o);this.apgmSpan=n}};function Ir(e){return`line ${e.line} column ${e.column}`}function g(e){return e!==void 0?` at ${Ir(e)}`:""}var N=class extends h{constructor(r,n,o){super();this.name=r;this.args=n;this.span=o}transform(r){return r(new N(this.name,this.args.map(n=>n.transform(r)),this.span))}pretty(){return`${this.name}(${this.args.map(r=>r.pretty()).join(", ")})`}};var M=class extends h{constructor(r,n,o,i,c){super();this.modifier=r;this.cond=n;this.thenBody=o;this.elseBody=i;this.span=c}transform(r){return r(new M(this.modifier,this.cond.transform(r),this.thenBody.transform(r),this.elseBody!==void 0?this.elseBody.transform(r):void 0,this.span))}pretty(){let r=`if_${this.modifier==="Z"?"z":"nz"}`,n=this.cond.pretty(),o=this.elseBody===void 0?"":` else ${this.elseBody.pretty()}`;return`${r} (${n}) ${this.thenBody.pretty()}`+o}};var B=class extends h{constructor(r){super();this.body=r}transform(r){return r(new B(this.body.transform(r)))}pretty(){return`loop ${this.body.pretty()}`}};var xt=class{constructor(t,r,n,o){this.name=t;this.args=r;this.body=n;this.span=o}pretty(){return`macro ${this.name}(${this.args.map(t=>t.pretty()).join(", ")}) ${this.body.pretty()}`}};var gt=class{constructor(t,r,n){this.macros=t;this.headers=r;this.seqExpr=n}pretty(){return[this.macros.map(t=>t.pretty()).join(`
`),this.headers.map(t=>t.toString()).join(`
`),this.seqExpr.prettyInner()].join(`
`)}};var At=class{constructor(t,r){this.name=t;this.content=r}toString(){let t=this.content.startsWith(" ")?"":" ";return`#${this.name}${t}${this.content}`}};var O=class extends h{constructor(r,n,o){super();this.value=r;this.span=n;this.raw=o}transform(r){return r(this)}pretty(){return this.value.toString()}};var V=class extends h{constructor(r,n){super();this.value=r;this.span=n}transform(r){return r(this)}pretty(){return'"'+this.value+'"'}};var $=class extends h{constructor(r){super();this.exprs=r}transform(r){return r(new $(this.exprs.map(n=>n.transform(r))))}pretty(){return`{${this.prettyInner()}}`}prettyInner(){return this.exprs.map(r=>r instanceof M||r instanceof B||r instanceof L?r.pretty():r.pretty()+";").join(`
`)}};var C=class extends h{constructor(r,n){super();this.name=r;this.span=n}transform(r){return r(this)}pretty(){return this.name}};var L=class extends h{constructor(r,n,o){super();this.modifier=r;this.cond=n;this.body=o}transform(r){return r(new L(this.modifier,this.cond.transform(r),this.body.transform(r)))}pretty(){return`while_${this.modifier==="Z"?"z":"nz"}(${this.cond.pretty()}) ${this.body.pretty()}`}};function Ot(e,t){let r=t.split(/\r?\n/),n=r[e.line-2],o=r[e.line-1],i=r[e.line],c=" ".repeat(Math.max(0,e.column-1))+"^",p=n===void 0?[]:[n],u=i===void 0?[]:[i],S=" | ",R=e.line.toString(),st=" ".repeat(R.length);return[...p.map(at=>st+S+at),R+S+o,st+S+c,...u.map(at=>st+S+at)]}function Ce(e,t){let r=Ot(e.location,t);return[`parse error at line ${e.location.line} column ${e.location.column}:`,`  expected ${e.expected.join(", ")}`,"",...r].join(`
`)}function Dr(e,t){let r=e.parse(t);if(r.type==="ParseOK")return r.value;throw new f(Ce(r,t),{start:r.location,end:r.location})}function Y(e,t){let r=t.length;return{start:e,end:{index:e.index+r-1,line:e.line,column:e.column+r}}}var _r=a.location.chain(e=>a.text('"').next(a.match(/[^"]*/)).skip(a.text('"')).desc(["string"]).map(t=>({value:t,span:Y(e,`"${t}"`)})));var Ze=a.match(/\/\*(\*(?!\/)|[^*])*\*\//s).desc([]),d=a.match(/\s*/).desc(["space"]).sepBy(Ze).map(()=>{}),ze=a.match(/\s+/).desc(["space"]),Ue=/[a-zA-Z_][a-zA-Z_0-9]*/u,Zr=a.match(Ue).desc(["identifier"]),ke=Zr.wrap(d,d),Fe=d.chain(()=>a.location.chain(e=>Zr.skip(d).map(t=>[t,Y(e,t)]))),We=/[a-zA-Z_][a-zA-Z_0-9]*!/u,zr=a.match(We).wrap(d,d).desc(["macro name"]);function v(e){return a.text(e).wrap(d,d)}function Or(e){return a.location.chain(r=>a.text(e).map(n=>[n,Y(r,e)])).wrap(d,d)}var Ve=v(",").desc(["`,`"]),Ur=v("(").desc(["`(`"]),kr=v(")").desc(["`)`"]),Ye=v(";").desc(["`;`"]),He=v("{").desc(["`{`"]),Xe=v("}").desc(["`}`"]),Fr=Fe.map(([e,t])=>new C(e,t));function Wr(e){return a.lazy(()=>e()).sepBy(Ve).wrap(Ur,kr)}function je(){return d.next(a.location).chain(e=>a.choice(zr,ke).chain(t=>Wr(()=>H()).map(r=>new N(t,r,Y(e,t)))))}var qe=a.location.chain(e=>vr.map(t=>new O(t.value,Y(e,t.raw),t.raw))).wrap(d,d),Ke=_r.wrap(d,d).map(e=>new V(e.value,e.span)),Vr=a.lazy(()=>an()).repeat(),Je=Vr.wrap(He,Xe).map(e=>new $(e)),Qe=a.choice(v("while_z"),v("while_nz")).map(e=>e==="while_z"?"Z":"NZ"),Yr=a.lazy(()=>H()).wrap(Ur,kr),Hr=Qe.chain(e=>Yr.chain(t=>H().map(r=>new L(e,t,r)))),Xr=v("loop").next(a.lazy(()=>H())).map(e=>new B(e)),tn=a.choice(Or("if_z"),Or("if_nz")).map(e=>e[0]==="if_z"?["Z",e[1]]:["NZ",e[1]]),jr=tn.chain(([e,t])=>Yr.chain(r=>a.lazy(()=>H()).chain(n=>a.choice(v("else").next(a.lazy(()=>H())),a.ok(void 0)).map(o=>new M(e,r,n,o,t))))),Cr="macro",rn=d.chain(e=>a.location.chain(t=>a.text(Cr).next(ze).map(r=>Y(t,Cr))));function fr(){return rn.and(zr).chain(([e,t])=>Wr(()=>Fr).map(r=>({span:e,name:t,args:r})))}function en(){return fr().chain(({span:e,name:t,args:r})=>a.lazy(()=>H()).map(n=>new xt(t,r,n,e)))}var nn=a.match(/.*/),on=a.text("#").next(a.match(/REGISTERS|COMPONENTS/)).desc(["#REGISTERS","#COMPONENTS"]).chain(e=>nn.map(t=>new At(e,t))),sn=on.wrap(d,d).repeat();function H(){return a.choice(Xr,Hr,jr,a.lazy(()=>je()),Je,Fr,qe,Ke)}function an(){return a.choice(Xr,Hr,jr,H().skip(Ye))}function cn(){return en().repeat().chain(e=>sn.chain(t=>Vr.wrap(d,d).map(r=>new gt(e,t,new $(r)))))}function qr(e){return Dr(cn(),e)}var E=class{constructor(){}};var y=class extends E{constructor(r){super();this.actions=r}transform(r){return r(this)}};var l=class extends E{constructor(r){super();this.exprs=r}transform(r){return r(new l(this.exprs.map(n=>n.transform(r))))}};function K(e){return e instanceof l&&e.exprs.every(t=>K(t))}function ot(e){if(e instanceof y)return e;if(e instanceof l&&e.exprs.length===1){let t=e.exprs[0];return ot(t)}}var I=class extends E{constructor(r,n,o){super();this.cond=r;this.thenBody=n;this.elseBody=o}transform(r){return r(new I(this.cond.transform(r),this.thenBody.transform(r),this.elseBody.transform(r)))}};var Z=class extends E{constructor(r){super();this.body=r;this.kind="loop"}transform(r){return r(new Z(this.body.transform(r)))}};var z=class extends E{constructor(r,n,o){super();this.modifier=r;this.cond=n;this.body=o}transform(r){return r(new z(this.modifier,this.cond.transform(r),this.body.transform(r)))}};var X=class extends E{constructor(r,n){super();this.level=r;this.span=n;this.kind="break"}transform(r){return r(this)}};var s=class{static incU(t){return s.nonReturn(`INC U${t}`)}static incUMulti(...t){return new y([...t.map(r=>`INC U${r}`),"NOP"])}static tdecU(t){return s.single(`TDEC U${t}`)}static addA1(){return s.nonReturn("ADD A1")}static addB0(){return s.single("ADD B0")}static addB1(){return s.single("ADD B1")}static incB2DX(){return s.nonReturn("INC B2DX")}static tdecB2DX(){return s.single("TDEC B2DX")}static incB2DY(){return s.nonReturn("INC B2DY")}static tdecB2DY(){return s.single("TDEC B2DY")}static readB2D(){return s.single("READ B2D")}static setB2D(){return s.nonReturn("SET B2D")}static incB(t){return s.nonReturn(`INC B${t}`)}static tdecB(t){return s.single(`TDEC B${t}`)}static readB(t){return s.single(`READ B${t}`)}static setB(t){return s.nonReturn(`SET B${t}`)}static haltOUT(){return s.single("HALT_OUT")}static mul0(){return s.single("MUL 0")}static mul1(){return s.single("MUL 1")}static nop(){return s.single("NOP")}static output(t){return s.nonReturn(`OUTPUT ${t}`)}static subA1(){return s.nonReturn("SUB A1")}static subB0(){return s.single("SUB B0")}static subB1(){return s.single("SUB B1")}static nonReturn(t){return new y([t,"NOP"])}static single(t){return new y([t])}};function un(e,t){if(e.args.length!==0)throw new f(`"${e.name}" expects empty argments${g(e.span?.start)}`,e.span);return t}function Kr(e,t){if(e.args.length!==1)throw new f(`number of arguments is not 1: "${e.name}"${g(e.span?.start)}`,e.span);let r=e.args[0];if(!(r instanceof O))throw new f(`argument is not a number: "${e.name}"${g(e.span?.start)}`,e.span);return t(r.value)}function pn(e,t){if(e.args.length!==1)throw new f(`number of arguments is not 1: "${e.name}"${g(e.span?.start)}`,e.span);let r=e.args[0];if(!(r instanceof V))throw new f(`argument is not a string: "${e.name}"${g(e.span?.start)}`,e.span);return t(r.value)}var Jr=new Map([["nop",s.nop()],["inc_b2dx",s.incB2DX()],["inc_b2dy",s.incB2DY()],["tdec_b2dx",s.tdecB2DX()],["tdec_b2dy",s.tdecB2DY()],["read_b2d",s.readB2D()],["set_b2d",s.setB2D()],["add_a1",s.addA1()],["add_b0",s.addB0()],["add_b1",s.addB1()],["sub_a1",s.subA1()],["sub_b0",s.subB0()],["sub_b1",s.subB1()],["mul_0",s.mul0()],["mul_1",s.mul1()],["halt_out",s.haltOUT()]]),Qr=new Map([["inc_u",s.incU],["tdec_u",s.tdecU],["inc_b",s.incB],["tdec_b",s.tdecB],["read_b",s.readB],["set_b",s.setB]]),te=new Map([["output",s.output]]);function fn(e){let t=Jr.get(e.name);if(t!==void 0)return un(e,t);let r=Qr.get(e.name);if(r!==void 0)return Kr(e,r);let n=te.get(e.name);if(n!==void 0)return pn(e,n);switch(e.name){case"break":return e.args.length===0?new X(void 0,e.span):Kr(e,o=>new X(o,e.span));case"repeat":{if(e.args.length!==2)throw new f(`"repeat" takes two arguments${g(e.span?.start)}`,e.span);let o=e.args[0];if(!(o instanceof O))throw new f(`first argument of "repeat" must be a number${g(e.span?.start)}`,e.span);let i=e.args[1];if(i===void 0)throw new Error("internal error");let c=Ct(i);return new l(Array(o.value).fill(0).map(()=>c))}}throw new f(`Unknown ${e.name.endsWith("!")?"macro":"function"}: "${e.name}"${g(e.span?.start)}`,e.span)}function Ct(e){let t=Ct;if(e instanceof N)return fn(e);if(e instanceof M)return e.modifier==="Z"?new I(t(e.cond),t(e.thenBody),e.elseBody===void 0?new l([]):t(e.elseBody)):new I(t(e.cond),e.elseBody===void 0?new l([]):t(e.elseBody),t(e.thenBody));if(e instanceof B)return new Z(t(e.body));if(e instanceof O)throw new f(`number is not allowed: ${e.raw??e.value}${g(e.span?.start)}`,e.span);if(e instanceof $)return new l(e.exprs.map(r=>t(r)));if(e instanceof V)throw new f(`string is not allowed: ${e.pretty()}${g(e.span?.start)}`,e.span);if(e instanceof L)return new z(e.modifier,t(e.cond),t(e.body));throw e instanceof C?new f(`macro variable is not allowed: variable "${e.name}"${g(e.span?.start)}`,e.span):Error("internal error")}function mn(e){let t="",r=!1,n=0;for(;n<e.length;){let o=e[n],i=e[n+1];o==="/"&&i==="*"?(n+=2,r=!0):o==="*"&&i==="/"?(r=!1,n+=2):(r||(t+=o),n++)}return t}function ln(e){let t=[],r=/(macro\s+([a-zA-Z_][a-zA-Z_0-9]*?!)\s*\(.*?\))/gs,n=mn(e).matchAll(r);for(let o of n){let i=fr().parse(o[0]);i.type==="ParseOK"&&t.push({name:i.value.name,args:i.value.args.map(c=>c.name)})}return t}function re(e){return e.transform(dn)}function dn(e){return e instanceof l?xn(e):e}function ee(e,t){let r=ne(mr(e),mr(t));return r===void 0?void 0:oe(r)}var hn=new b;function ne(e,t){if(e.length===0)return t.slice();if(t.length===0)return e.slice();if(e.some(u=>u instanceof x)||t.some(u=>u instanceof x))return;let r=e.filter(u=>!(u instanceof b)),n=t.filter(u=>!(u instanceof b)),o=r.every(u=>!u.doesReturnValue()),i=n.every(u=>!u.doesReturnValue());if(!o&&!i||!r.every(u=>n.every(S=>!u.isSameComponent(S))))return;let p=r.concat(n);return o&&i&&p.push(hn),p}function mr(e){return e.actions.flatMap(t=>{let r=et(t);return r!==void 0?[r]:[]})}function oe(e){return new y(e.map(t=>t.pretty()))}function xn(e){let t=[],r=[],n=()=>{r.length!==0&&(t.push(oe(r)),r=[])};for(let o of e.exprs)if(o instanceof y){let i=mr(o),c=ne(r,i);c===void 0?(n(),r=i):r=c}else n(),t.push(o);return n(),new l(t)}var P=class{constructor(t,r,n){this.input=t;this.output=r;this.inputZNZ=n}};function gn(e){let t=e.prevOutput,r=t;return(t==="*"||t==="Z")&&(r=" "+t),`${e.currentState}; ${r}; ${e.nextState}; ${e.actions.join(", ")}`}var T=class{constructor(t){this.inner=t;if(this.inner.actions.length===0)throw Error("actions must be nonempty")}},lr=class{#o=0;#e=[];#n;#i;constructor(t={}){this.#n=t.prefix??"STATE_",this.#i=!(t.noOptimize??!1)}#r(){return this.#o++,`${this.#n}${this.#o}`}#s(t,r,n="*"){return new T({currentState:t,prevOutput:n,nextState:r,actions:["NOP"]})}transpile(t){let r="INITIAL",n=this.#r()+"_INITIAL",o=this.#s(r,n,"ZZ"),i=this.#n+"END",c=this.#t(new P(n,i,"*"),t),p=new T({currentState:i,prevOutput:"*",nextState:i,actions:["HALT_OUT"]});return[o,...c,p].map(u=>gn(u.inner))}#t(t,r){if(r instanceof y)return[this.#c(t,r)];if(r instanceof l)return this.#p(t,r);if(r instanceof I)return this.#f(t,r);if(r instanceof Z)return this.#m(t,r);if(r instanceof z)return this.#d(t,r);if(r instanceof X)return this.#h(t,r);throw Error("unknown expr")}#c(t,r){return new T({currentState:t.input,prevOutput:t.inputZNZ,nextState:t.output,actions:r.actions})}#p(t,r){if(K(r))return[this.#s(t.input,t.output,t.inputZNZ)];if(r.exprs.length===1){let c=r.exprs[0];if(c===void 0)throw new Error("internal error");return this.#t(t,c)}let n=[],o=t.input,i=r.exprs.length-1;for(let[c,p]of r.exprs.entries())if(c!==i){let u=this.#r();n=n.concat(this.#t(new P(o,u,c===0?t.inputZNZ:"*"),p)),o=u}else n=n.concat(this.#t(new P(o,t.output,"*"),p));return n}#f(t,r){if(this.#i&&K(r.thenBody)&&K(r.elseBody))return this.#t(t,r.cond);let n=this.#r(),o=this.#t(new P(t.input,n,t.inputZNZ),r.cond),[i,...c]=this.#t(new P(n,t.output,"Z"),r.thenBody),[p,...u]=this.#t(new P(n,t.output,"NZ"),r.elseBody);return[...o,i,p,...c,...u]}#m(t,r){let{startState:n,fromZOrNZ:o}=this.#a(t);this.#e.push(t.output);let i=this.#t(new P(n,n,"*"),r.body);return this.#e.pop(),[...o,...i]}#u(t,r,n,o){let{startState:i,fromZOrNZ:c}=this.#a(t),p=this.#r(),u=this.#c(new P(i,p,"*"),r),S=new T({currentState:p,prevOutput:"Z",nextState:o==="Z"?p:t.output,actions:o==="Z"?n.actions:["NOP"]}),R=new T({currentState:p,prevOutput:"NZ",nextState:o==="Z"?t.output:p,actions:o==="Z"?["NOP"]:n.actions});return[...c,u,S,R]}#l(t,r,n){let{startState:o,fromZOrNZ:i}=this.#a(t),c=this.#r(),p=this.#t(new P(o,c,"*"),r),u=new T({currentState:c,prevOutput:"Z",nextState:n==="Z"?o:t.output,actions:["NOP"]}),S=new T({currentState:c,prevOutput:"NZ",nextState:n==="Z"?t.output:o,actions:["NOP"]});return[...i,...p,u,S]}#d(t,r){let n=this.#i;if(n&&K(r.body)){let J=ot(r.cond);return J!==void 0?this.#u(t,J,J,r.modifier):this.#l(t,r.cond,r.modifier)}let o=ot(r.body),i=ot(r.cond);if(n&&i!==void 0&&o!==void 0){let J=ee(o,i);if(J!==void 0)return this.#u(t,i,J,r.modifier)}let{startState:c,fromZOrNZ:p}=this.#a(t),u=this.#r(),S=this.#t(new P(c,u,"*"),r.cond),R=this.#r()+"_WHILE_BODY",st=new T({currentState:u,prevOutput:"Z",nextState:r.modifier==="Z"?R:t.output,actions:["NOP"]}),hr=new T({currentState:u,prevOutput:"NZ",nextState:r.modifier==="Z"?t.output:R,actions:["NOP"]});this.#e.push(t.output);let at=this.#t(new P(R,c,"*"),r.body);return this.#e.pop(),[...p,...S,st,hr,...at]}#a(t){let r=t.inputZNZ==="*"?t.input:this.#r(),n=t.inputZNZ==="*"?[]:[this.#s(t.input,r,t.inputZNZ)];return{startState:r,fromZOrNZ:n}}#h(t,r){let n=r.level??1;if(n<1)throw new f("break level is less than 1",r.span);let o=this.#e[this.#e.length-n];if(o===void 0)throw n===1?new f("break outside while or loop",r.span):new f("break level is greater than number of nests of while or loop",r.span);return[this.#s(t.input,o,t.inputZNZ)]}};function dr(e,t={}){return new lr(t).transpile(e)}function ie(e){let t=new Set,r=[];for(let n of e)t.has(n)?r.push(n):t.add(n);return r}function se(e){return`${e} argument${e===1?"":"s"}`}function An(){throw new Error("internal error")}function bn(e,t){let r=t.args;if(r.length!==e.args.length)throw new f(`Error at "${e.name}": this macro takes ${se(e.args.length)} but ${se(r.length)} was supplied`+ +`${g(t.span?.start)}`,t.span);let n=new Map(e.args.map((o,i)=>[o.name,r[i]??An()]));return e.body.transform(o=>{if(o instanceof C){let i=n.get(o.name);if(i===void 0)throw new f(`scope error: Unknown variable "${o.name}"${g(o.span?.start)}`,o.span);return i}else return o})}var En=1e5,bt=class{constructor(t,r){this.#e=0;this.main=t,this.#o=r}#o;#e;static make(t){let r=new Map(t.macros.map(n=>[n.name,n]));if(r.size<t.macros.length){let o=ie(t.macros.map(p=>p.name))[0],i=t.macros.slice().reverse().find(p=>p.name===o)?.span,c=i?.start;throw new f(`There is a macro with the same name: "${o}"`+g(c),i)}return new bt(t,r)}expand(){return this.#n(this.main.seqExpr)}#n(t){if(En<this.#e)throw Error("too many macro expansion");return this.#e++,t.transform(r=>this.#i(r))}#i(t){return t instanceof N?this.#r(t):t}#r(t){let r=this.#o.get(t.name);if(r!==void 0){let n=bn(r,t);return this.#n(n)}else return t}};function ae(e){return bt.make(e).expand()}function ce(e){return e.transform(yn)}function yn(e){return e instanceof l?Sn(e):e}function Sn(e){let t=[];for(let r of e.exprs)r instanceof l?t=t.concat(r.exprs):t.push(r);return new l(t)}function it(e=void 0,t,...r){e&&console.log(e+" Start",performance.now());let n=t(...r);return e&&console.log(e+" End",performance.now()),n}function Pn(e,{log:t,noOptimize:r}){if(r===!0)return e;let n=it(t?"optimize apgl seq":void 0,ce,e);return it(t?"optimize apgl action":void 0,re,n)}function Np(e,t={}){let r=t.log??!1,n=it(r?"apgm parse":void 0,qr,e);try{let o=it(r?"apgm macro expaned":void 0,ae,n),i=it(r?"apgm to apgl":void 0,Ct,o),c=Pn(i,{log:r,noOptimize:t.noOptimize}),p=it(r?"apgl to apgsembly":void 0,dr,c,t),u=["# State    Input    Next state    Actions","# ---------------------------------------"];return n.headers.map(R=>R.toString()).concat(u,p)}catch(o){throw o instanceof f&&o.apgmSpan?new f([o.message,...Ot(o.apgmSpan.start,e)].join(`
`),o.apgmSpan,{cause:o.cause}):o}}export{ln as completionParser,Jr as emptyArgFuncs,Np as integration,Qr as numArgFuncs,te as strArgFuncs};
