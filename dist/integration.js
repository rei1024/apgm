var Fr=Object.defineProperty;var Wr=(e,t)=>{for(var r in t)Fr(e,r,{get:t[r],enumerable:!0})};var p={};Wr(p,{Parser:()=>F,all:()=>We,choice:()=>Vr,eof:()=>Fe,fail:()=>Hr,lazy:()=>Xr,location:()=>ne,match:()=>jr,ok:()=>Pt,text:()=>Yr});var F=class gt{constructor(t){this.action=t}parse(t){let r={index:0,line:1,column:1},n=new Kr({input:t,location:r}),o=this.skip(Fe).action(n);return o.type==="ActionOK"?{type:"ParseOK",value:o.value}:{type:"ParseFail",location:o.furthest,expected:o.expected}}tryParse(t){let r=this.parse(t);if(r.type==="ParseOK")return r.value;let{expected:n,location:o}=r,{line:s,column:i}=o,c=`parse error at line ${s} column ${i}: expected ${n.join(", ")}`;throw new Error(c)}and(t){return new gt(r=>{let n=this.action(r);if(n.type==="ActionFail")return n;r=r.moveTo(n.location);let o=r.merge(n,t.action(r));if(o.type==="ActionOK"){let s=[n.value,o.value];return r.merge(o,r.ok(o.location.index,s))}return o})}skip(t){return this.and(t).map(([r])=>r)}next(t){return this.and(t).map(([,r])=>r)}or(t){return new gt(r=>{let n=this.action(r);return n.type==="ActionOK"?n:r.merge(n,t.action(r))})}chain(t){return new gt(r=>{let n=this.action(r);if(n.type==="ActionFail")return n;let o=t(n.value);return r=r.moveTo(n.location),r.merge(n,o.action(r))})}map(t){return this.chain(r=>Pt(t(r)))}thru(t){return t(this)}desc(t){return new gt(r=>{let n=this.action(r);return n.type==="ActionOK"?n:{type:"ActionFail",furthest:n.furthest,expected:t}})}wrap(t,r){return t.next(this).skip(r)}trim(t){return this.wrap(t,t)}repeat(t=0,r=1/0){if(!ke(t,r))throw new Error(`repeat: bad range (${t} to ${r})`);return t===0?this.repeat(1,r).or(Pt([])):new gt(n=>{let o=[],s=this.action(n);if(s.type==="ActionFail")return s;for(;s.type==="ActionOK"&&o.length<r;){if(o.push(s.value),s.location.index===n.location.index)throw new Error("infinite loop detected; don't call .repeat() with parsers that can accept zero characters");n=n.moveTo(s.location),s=n.merge(s,this.action(n))}return s.type==="ActionFail"&&o.length<t?s:n.merge(s,n.ok(n.location.index,o))})}sepBy(t,r=0,n=1/0){if(!ke(r,n))throw new Error(`sepBy: bad range (${r} to ${n})`);return r===0?this.sepBy(t,1,n).or(Pt([])):n===1?this.map(o=>[o]):this.chain(o=>t.next(this).repeat(r-1,n-1).map(s=>[o,...s]))}node(t){return We(ne,this,ne).map(([r,n,o])=>({type:"ParseNode",name:t,value:n,start:r,end:o}))}};function ke(e,t){return e<=t&&e>=0&&t>=0&&Number.isInteger(e)&&e!==1/0&&(Number.isInteger(t)||t===1/0)}var ne=new F(e=>e.ok(e.location.index,e.location));function Pt(e){return new F(t=>t.ok(t.location.index,e))}function Hr(e){return new F(t=>t.fail(t.location.index,e))}var Fe=new F(e=>e.location.index<e.input.length?e.fail(e.location.index,["<EOF>"]):e.ok(e.location.index,"<EOF>"));function Yr(e){return new F(t=>{let r=t.location.index,n=r+e.length;return t.input.slice(r,n)===e?t.ok(n,e):t.fail(r,[e])})}function jr(e){for(let r of e.flags)switch(r){case"i":case"s":case"m":case"u":continue;default:throw new Error("only the regexp flags 'imsu' are supported")}let t=new RegExp(e.source,e.flags+"y");return new F(r=>{let n=r.location.index;t.lastIndex=n;let o=r.input.match(t);if(o){let s=n+o[0].length,i=r.input.slice(n,s);return r.ok(s,i)}return r.fail(n,[String(e)])})}function We(...e){return e.reduce((t,r)=>t.chain(n=>r.map(o=>[...n,o])),Pt([]))}function Vr(...e){return e.reduce((t,r)=>t.or(r))}function Xr(e){let t=new F(r=>(t.action=e().action,t.action(r)));return t}function qr(e,t){return[...new Set([...e,...t])]}var Kr=class He{constructor(t){this.input=t.input,this.location=t.location}moveTo(t){return new He({input:this.input,location:t})}_internal_move(t){if(t===this.location.index)return this.location;let r=this.location.index,n=t,o=this.input.slice(r,n),{line:s,column:i}=this.location;for(let c of o)c===`
`?(s++,i=1):i++;return{index:t,line:s,column:i}}ok(t,r){return{type:"ActionOK",value:r,location:this._internal_move(t),furthest:{index:-1,line:-1,column:-1},expected:[]}}fail(t,r){return{type:"ActionFail",furthest:this._internal_move(t),expected:r}}merge(t,r){if(r.furthest.index>t.furthest.index)return r;let n=r.furthest.index===t.furthest.index?qr(t.expected,r.expected):t.expected;return r.type==="ActionOK"?{type:"ActionOK",location:r.location,value:r.value,furthest:t.furthest,expected:n}:{type:"ActionFail",furthest:t.furthest,expected:n}}};var h=class{pretty(){return""}doesReturnValue(){return!1}isSameComponent(t){return!0}};var oe="A1",se="B0",ie="B1",Ye="ADD",Jr=e=>{switch(e){case 0:return oe;case 1:return se;case 2:return ie}},Qr=e=>{switch(e){case oe:return 0;case se:return 1;case ie:return 2}},W=class e extends h{constructor(t){super(),this.op=t}pretty(){return`${Ye} ${Jr(this.op)}`}static parse(t){let r=t.trim().split(/\s+/u);if(r.length!==2)return;let[n,o]=r;if(n===Ye&&(o===oe||o===se||o===ie))return new e(Qr(o))}doesReturnValue(){switch(this.op){case 0:return!1;case 1:return!0;case 2:return!0}}isSameComponent(t){return t instanceof e}};var Rt="INC",ae="TDEC",Ct="READ",_t="SET",ce="B2DX",pe="B2DY",ue="B2D",tn="DEC",je="SQX",Ve="SQY",Xe="SQ",qe=e=>{switch(e){case Rt:return 0;case ae:return 1;case Ct:return 2;case _t:return 3}},en=e=>{switch(e){case 0:return Rt;case 1:return ae;case 2:return Ct;case 3:return _t}},Ke=e=>{switch(e){case ce:return 4;case pe:return 5;case ue:return 6}},rn=e=>{switch(e){case 4:return ce;case 5:return pe;case 6:return ue}},ot=class e extends h{constructor(t,r){super(),this.op=t,this.axis=r}pretty(){return`${en(this.op)} ${rn(this.axis)}`}static parse(t){let r=t.trim().split(/\s+/u);if(r.length!==2)return;let[n,o]=r;if(!(n===void 0||o===void 0)){if(n===Rt||n===ae){if(o===ce||o===pe)return new e(qe(n),Ke(o))}else if((n===Ct||n===_t)&&o===ue)return new e(qe(n),Ke(o));switch(n){case Rt:switch(o){case je:return new e(0,4);case Ve:return new e(0,5);default:return}case tn:switch(o){case je:return new e(1,4);case Ve:return new e(1,5);default:return}case Ct:switch(o){case Xe:return new e(2,6);default:return}case _t:switch(o){case Xe:return new e(3,6);default:return}}}}doesReturnValue(){switch(this.op){case 0:return!1;case 1:return!0;case 2:return!0;case 3:return!1}}isSameComponent(t){if(t instanceof e){let r=this.axis,n=t.axis;return r===4&&n===5?!1:!(r===5&&n===4)}return!1}};var me="INC",fe="TDEC",le="READ",de="SET",Je="B",nn=e=>{switch(e){case 0:return me;case 1:return fe;case 2:return le;case 3:return de}},on=e=>{switch(e){case me:return 0;case fe:return 1;case le:return 2;case de:return 3}},O=class e extends h{constructor(t,r){super(),this.op=t,this.regNumber=r,this.registerCache=void 0}pretty(){return`${nn(this.op)} ${Je}${this.regNumber}`}static parse(t){let r=t.trim().split(/\s+/u);if(r.length!==2)return;let[n,o]=r;if(!(n===void 0||o===void 0)&&(n===me||n===fe||n===le||n===de)&&o.startsWith(Je)){let s=o.slice(1);if(/^[0-9]+$/u.test(s))return new e(on(n),parseInt(s,10))}}doesReturnValue(){switch(this.op){case 0:return!1;case 1:return!0;case 2:return!0;case 3:return!1}}isSameComponent(t){return t instanceof e?this.regNumber===t.regNumber:!1}};var Qe="HALT_OUT",tr="HALT",P=class e extends h{constructor(t=!0){super(),this.output=t}pretty(){return this.output?Qe:tr}static parse(t){let r=t.trim().split(/\s+/u);if(r.length!==1)return;let[n]=r;if(n===Qe)return new e(!0);if(n===tr)return new e(!1)}doesReturnValue(){return!1}isSameComponent(t){return t instanceof e}};var ge="0",Ae="1",er="MUL",sn=e=>{switch(e){case ge:return 0;case Ae:return 1}},an=e=>{switch(e){case 0:return ge;case 1:return Ae}},st=class e extends h{constructor(t){super(),this.op=t}pretty(){return`${er} ${an(this.op)}`}static parse(t){let r=t.trim().split(/\s+/u);if(r.length!==2)return;let[n,o]=r;if(n===er&&(o===ge||o===Ae))return new e(sn(o))}doesReturnValue(){return!0}isSameComponent(t){return t instanceof e}};var rr="NOP",T=class e extends h{constructor(){super()}pretty(){return rr}static parse(t){let r=t.trim().split(/\s+/u);if(r.length!==1)return;let[n]=r;if(n===rr)return new e}doesReturnValue(){return!0}isSameComponent(t){return t instanceof e}};var nr="OUTPUT",it=class e extends h{constructor(t){super(),this.digit=t}pretty(){return`${nr} ${this.digit}`}static parse(t){let r=t.trim().split(/\s+/u);if(r.length!==2)return;let[n,o]=r;if(n===nr&&o!==void 0)return new e(o)}doesReturnValue(){return!1}isSameComponent(t){return t instanceof e}};var be="A1",Ee="B0",Se="B1",or="SUB",cn=e=>{switch(e){case 0:return be;case 1:return Ee;case 2:return Se}},pn=e=>{switch(e){case be:return 0;case Ee:return 1;case Se:return 2}},at=class e extends h{constructor(t){super(),this.op=t}pretty(){return`${or} ${cn(this.op)}`}static parse(t){let r=t.trim().split(/\s+/u);if(r.length!==2)return;let[n,o]=r;if(n===or&&(o===be||o===Ee||o===Se))return new e(pn(o))}doesReturnValue(){switch(this.op){case 0:return!1;case 1:return!0;case 2:return!0}}isSameComponent(t){return t instanceof e}};var ye="INC",Pe="TDEC",sr="U",un="R",mn=e=>{switch(e){case 0:return ye;case 1:return Pe}},fn=e=>{switch(e){case ye:return 0;case Pe:return 1}},R=class e extends h{constructor(t,r){super(),this.op=t,this.regNumber=r,this.registerCache=void 0}pretty(){return`${mn(this.op)} ${sr}${this.regNumber}`}static parse(t){let r=t.trim().split(/\s+/u);if(r.length!==2)return;let[n,o]=r;if(!(n===void 0||o===void 0)&&(n===ye||n===Pe)&&(o.startsWith(sr)||o.startsWith(un))){let s=o.slice(1);if(/^[0-9]+$/u.test(s))return new e(fn(n),parseInt(s,10))}}doesReturnValue(){switch(this.op){case 0:return!1;case 1:return!0}}isSameComponent(t){return t instanceof e?this.regNumber===t.regNumber:!1}};var we="INC",Ge="DEC",Ne="READ",Me="SET",Be="RESET",ln=e=>{switch(e){case 0:return we;case 1:return Ge;case 2:return Ne;case 3:return Me;case 4:return Be}},dn=e=>{switch(e){case we:return 0;case Ge:return 1;case Ne:return 2;case Me:return 3;case Be:return 4}},ct=class e extends h{constructor(t,r){super(),this.op=t,this.regNumber=r}pretty(){return`${ln(this.op)} T${this.regNumber}`}static parse(t){let r=t.trim().split(/\s+/u);if(r.length!==2)return;let[n,o]=r;if(!(n===void 0||o===void 0)&&(n===we||n===Ge||n===Ne||n===Me||n===Be)&&o.startsWith("T")){let s=o.slice(1);if(/^[0-9]+$/u.test(s))return new e(dn(n),parseInt(s,10))}}doesReturnValue(){switch(this.op){case 0:return!0;case 1:return!0;case 2:return!0;case 3:return!1;case 4:return!1}}isSameComponent(t){return t instanceof e?this.regNumber===t.regNumber:!1}};var hn=[O.parse,R.parse,ot.parse,T.parse,W.parse,st.parse,at.parse,it.parse,P.parse,ct.parse],pt=e=>{for(let t of hn){let r=t(e);if(r!==void 0)return r}};var m=()=>{throw Error("internal error")};var G=e=>e!==void 0?` at line ${e}`:"";function Le(e,t,r,n){if(e=e.trim(),!e.startsWith("{"))return`Invalid line "${r}"${G(t)}. ${n} replacements does not start with "{"`;if(!e.endsWith("}"))return`Invalid line "${r}"${G(t)}. ${n} replacements does not end with "}"`;try{return e.slice(1,-1).slice().split(";").map(o=>{let s=o.trim().split("=").map(i=>i.trim());if(s.length!=2)throw new Error(`Invalid line "${r}"${G(t)}. #DEFINE invalid replacements`);return{needle:s[0]??m(),replacement:s[1]??m()}})}catch(o){return o instanceof Error?o.message:m()}}var $e="INITIAL",B=class{pretty(){return""}},ut=class e extends B{constructor(t){super(),this.content=t}static get key(){return"#COMPONENTS"}pretty(){return e.key+" "+this.content}},mt=class e extends B{constructor(t){super(),this.content=t}static get key(){return"#REGISTERS"}pretty(){return e.key+" "+this.content}};function ir(e){return"{ "+e.map(t=>t.needle+" = "+t.replacement).join("; ")+" }"}var ft=class e extends B{constructor(t,r){super(),this.name=t,this.defaultReplacements=r}static get key(){return"#DEFINE"}pretty(){return e.key+" "+this.name+(this.defaultReplacements.length===0?"":" "+ir(this.defaultReplacements))}},Y=class e extends B{constructor(){super()}static get key(){return"#ENDDEF"}pretty(){return e.key}},H=class e extends B{constructor(t,r){super(),this.templateName=t,this.replacements=r}static get key(){return"#INSERT"}pretty(){return e.key+" "+this.templateName+(this.replacements.length===0?"":" "+ir(this.replacements))}},lt=class extends B{constructor(t){super(),this.filename=t}static get key(){return"#INCLUDE"}pretty(){return H.key+" "+this.filename}},Te=class extends B{constructor(t){super(),this.str=t}getString(){return this.str}pretty(){return this.getString()}},De=class extends B{constructor(){super()}pretty(){return""}},gn=e=>{switch(e){case"Z":return e;case"NZ":return e;case"ZZ":return e;case"*":return e;default:return}},j=class extends B{constructor({state:t,input:r,nextState:n,actions:o,line:s}){super(),this.state=t,this.input=r,this.nextState=n,this.actions=o,this.line=s,this._string=`${this.state}; ${this.input};${" ".repeat(2-this.input.length)} ${this.nextState}; ${this.actions.map(i=>i.pretty()).join(", ")}`}pretty(){return this._string}},Ie=(e,t)=>{let r=e.trim();if(r==="")return new De;if(r.startsWith("#")){if(r.startsWith(ut.key))return new ut(r.slice(ut.key.length).trim());if(r.startsWith(mt.key))return new mt(r.slice(mt.key.length).trim());if(r.startsWith(ft.key)){let d=r.slice(ft.key.length).trim();if(d.length===0)return`Invalid line "${e}"${G(t)}. #DEFINE needs a name.`;let M,y=[],tt=d.indexOf("{");if(tt!==-1){M=d.slice(0,tt).trim();let et=Le(d.slice(tt),t,e,"#DEFINE");if(typeof et=="string")return et;y=et}else M=d;return new ft(M,y??[])}else{if(r.startsWith(Y.key))return new Y;if(r.startsWith(H.key)){let d=r.slice(H.key.length).trim();if(d.length===0)return`Invalid line "${e}"${G(t)}. #INSERT needs a name.`;let M,y=[],tt=d.indexOf("{");if(tt!==-1){M=d.slice(0,tt).trim();let et=Le(d.slice(tt),t,e,"#INSERT");if(typeof et=="string")return et;y=et}else M=d;return new H(M,y)}else if(r.startsWith(lt.key)){let d=r.slice(lt.key.length).trim();return d===""?`Invalid line "${e}"${G(t)}. #INCLUDE needs filename.`:new lt(d)}}return new Te(e)}let o=(r.split("#")[0]??"").split(/\s*;\s*/u);if(o.length<4)return`Invalid line "${e}"${G(t)}`;if(o.length>4)return o[4]===""?`Extraneous semicolon "${e}"${G(t)}`:`Invalid line "${e}"${G(t)}`;let s=o[0]??m(),i=o[1]??m(),c=o[2]??m(),u=(o[3]??m()).trim().split(/\s*,\s*/u).filter(d=>d!==""),x=[];for(let d of u){let M=pt(d);if(M===void 0)return`Unknown action "${d}" in "${e}"${G(t)}`;x.push(M)}let E=gn(i);return E===void 0?`Unknown input "${i}" in "${e}"${G(t)}. Expect "Z", "NZ", "ZZ" or "*"`:new j({state:s,input:E,nextState:c,actions:x,line:t})},qt=e=>G(e.line),C=e=>`"${e.pretty()}"${qt(e)}`;var ar=e=>{let t=e.actions;if(t.some(n=>n instanceof P))return;let r=t.filter(n=>n.doesReturnValue());if(r.length!==1)return r.length===0?`Does not return a value in ${C(e)}`:`Does not contain exactly one action that returns a value in "${e.pretty()}": Actions that produce value are ${r.map(n=>`"${n.pretty()}"`).join(", ")}${qt(e)}`};var cr=e=>{if(e.nextState===$e)return`Return to initial state in ${C(e)}`};var pr=e=>{let t=e.actions;if(t.length<=1)return;let r=t.map(o=>o.pretty());r.sort();let n=r.length-1;for(let o=0;o<n;o++){let s=r[o],i=r[o+1];if(s===i)return`Duplicated actions "${s}" in ${C(e)}`}};var ur=e=>{let t=e.actions;if(t.find(n=>n instanceof P)!==void 0)return;let r=t.length;if(!(r<=1))for(let n=0;n<r;n++){let o=t[n]??m();for(let s=n+1;s<r;s++){let i=t[s]??m();if(o.isSameComponent(i))return`Actions "${o.pretty()}" and "${i.pretty()}" use same component in ${C(e)}`}}};var An=(e,t)=>e.line!==void 0&&t?.line!==void 0?` at line ${e.line} and ${t.line}`:"",mr=e=>{if(e.length===0)return;let t=(o,s)=>`Need Z line followed by NZ line in "${o.pretty()}"${An(o,s)}`,r=e.length-1;for(let o=0;o<r;o++){let s=e[o]??m(),i=e[o+1]??m(),c=s.input,a=i.input;if(c==="Z"&&a!=="NZ"||a==="NZ"&&c!=="Z"||c==="Z"&&a==="NZ"&&s.state!==i.state)return[t(s,i)]}let n=e[r];if(n?.input==="Z")return[t(n)]};var qi=Number.parseInt,Ki=Number.isNaN;var I=class e{constructor(t,r=new Map){this.templates=r,this.array=t}getArray(){return this.array}getTemplates(){return this.templates}pretty(){return this.array.map(t=>t.pretty()).join(`
`)}static parse(t){let r=t.split(/\r\n|\n|\r/u),n=[],o=[],s=new Map,i=null;for(let[c,a]of r.entries()){if(i!=null){if(a.trimStart().startsWith(Y.key)&&Ie(a,c+1)instanceof Y){i=null;continue}let x=s.get(i);x==null&&m(),x.lines.push(a);continue}let u=Ie(a,c+1);if(u instanceof ft){if(i!=null)return`#DEFINE needs #ENDDEF ${u.pretty()}`;if(i=u.name,s.has(i))return`#DEFINE duplicate template name ${u.pretty()}`;s.set(i,{defaultReplacements:u.defaultReplacements,lines:[]})}else{if(u instanceof Y)return`#ENDDEF needs #DEFINE ${u.pretty()}`;u instanceof B?o.push(u):typeof u=="string"?n.push(u):m()}}return i!=null&&n.push(`#DEFINE needs #ENDDEF. "${i}"`),n.length>0?n.join(`
`):new e(o,s)}};function ve(e){let t=e.getArray(),r=t.flatMap(s=>s instanceof j?[s]:[]),n=r.reduce((s,i)=>Math.max(s,i.state.length),0),o=r.reduce((s,i)=>Math.max(s,i.nextState.length),0);return t.map(s=>{if(s instanceof j){let i=n-s.state.length,c=2-s.input.length,a=o-s.nextState.length;return`${s.state}; ${" ".repeat(i)}${s.input}; ${" ".repeat(c)}${s.nextState}; ${" ".repeat(a)}${s.actions.map(u=>u.pretty()).join(", ")}`}else return s.pretty()}).join(`
`)}var fr=e=>{let t=[];{let r=[pr,ar,ur,cr];for(let n of e)for(let o of r){let s=o(n);typeof s=="string"&&t.push(s)}}{let r=[mr];for(let n of r){let o=n(e);o!==void 0&&(t=t.concat(o))}}if(t.length>0)return t.join(`
`)};function bn(e,t,r){let n=e;for(let o of r)n=n.replaceAll(o.needle,o.replacement);for(let o of t.defaultReplacements)n=n.replaceAll(o.needle,o.replacement);return n}function lr(e,t){let r=[],n=new Map(e.getTemplates().entries()),o=e.getArray().slice().reverse();function s(i){let c=i.getArray();for(let a=c.length-1;a>=0;a--)o.push(c[a]??m());for(let[a,u]of i.getTemplates()){if(n.get(a)!=null)throw new Error(`#DEFINE duplicate template name "${a}"`);n.set(a,u)}}for(;o.length>=1;){let i=o.pop();if(i instanceof j)r.push(i);else if(i instanceof lt){let c=t.find(a=>a.name===i.filename);if(c==null)throw new Error(`#INCLUDE file not found: "${i.filename}". Add a library file.`);s(c.programLines)}else if(i instanceof H){let c=n.get(i.templateName);if(c==null)throw new Error(`Undefined template: "${i.templateName}" at line "${i.pretty()}"`);let a=c.lines.map(x=>bn(x,c,i.replacements)).join(`
`),u=I.parse(a);if(typeof u=="string")throw new Error(u);s(u)}}return r}var Et=class e{constructor(t,r,n){this.commands=t,this.componentsHeader=r,this.registersHeader=n}static parse(t,{noValidate:r,libraryFiles:n}={}){let o=I.parse(t);if(typeof o=="string")return o;let s=[];for(let c of n??[]){let a=I.parse(c.content);if(typeof a=="string")return a;s.push({name:c.name,programLines:a})}let i=lr(o,s);if(!r){if(i.length===0)return"Program is empty";let c=fr(i);if(typeof c=="string")return c}return new e(i,o.getArray().flatMap(c=>c instanceof ut?[c]:[]),o.getArray().flatMap(c=>c instanceof mt?[c]:[]))}},En=e=>[...new Set(e)].sort((t,r)=>t-r),Kt=e=>{let t=e.commands.flatMap(a=>a.actions),r=a=>En(t.flatMap(u=>u instanceof a?[u.regNumber]:[])),n=!1,o=!1,s=!1,i=!1,c=!1;for(let a of t)a instanceof W?n=!0:a instanceof at?o=!0:a instanceof st?s=!0:a instanceof ot?i=!0:a instanceof it&&(c=!0);return{unary:r(R),binary:r(O),legacyT:r(ct),hasAdd:n,hasSub:o,hasMul:s,hasB2D:i,hasOutput:c}};function dr(e){if(e.length===0)return[];let t=[],r=e[0],n=e[0]??m(),o=e.length;for(let s=1;s<o;s++){let i=e[s]??m();i===n+1||(t.push(r===n?`${r}`:`${r}-${n}`),r=i),n=i}return t.push(r===n?`${r}`:`${r}-${n}`),t}var Oe=e=>{let t=[];e.hasB2D&&t.push("B2D");let r=e.binary.slice().sort((o,s)=>o-s);t=t.concat(dr(r).map(o=>"B"+o));let n=e.unary.slice().sort((o,s)=>o-s);return t=t.concat(dr(n).map(o=>"U"+o)),e.hasAdd&&t.push("ADD"),e.hasSub&&t.push("SUB"),e.hasMul&&t.push("MUL"),e.hasOutput&&t.push("OUTPUT"),t.join(", ")};function hr(e){let t=I.parse(e);if(typeof t=="string")throw new Error(t);return ve(t)}function Re(e){let t=Et.parse(e);if(typeof t=="string")throw new Error(t);return Oe(Kt(t))}var yn=p.match(/[0-9]+/).desc(["number"]).map(e=>({raw:e,value:parseInt(e,10)})),Pn=p.match(/0x[a-fA-F0-9]+/).desc(["hexadecimal number"]).map(e=>({raw:e,value:parseInt(e,16)})),xr=Pn.or(yn).desc(["number"]);var A=class{constructor(){}},f=class extends Error{constructor(r,n,o){super(r,o);this.apgmSpan=n}};function gr(e){return`line ${e.line} column ${e.column}`}function S(e){return e!==void 0?` at ${gr(e)}`:""}var D=class e extends A{constructor(r,n,o){super();this.name=r;this.args=n;this.span=o}transform(r){return r(new e(this.name,this.args.map(n=>n.transform(r)),this.span))}pretty(){return`${this.name}(${this.args.map(r=>r.pretty()).join(", ")})`}getSpan(){return this.span}};var _=class e extends A{constructor(r,n,o,s,i){super();this.modifier=r;this.cond=n;this.thenBody=o;this.elseBody=s;this.span=i}transform(r){return r(new e(this.modifier,this.cond.transform(r),this.thenBody.transform(r),this.elseBody!==void 0?this.elseBody.transform(r):void 0,this.span))}pretty(){let r=`if_${this.modifier==="Z"?"z":"nz"}`,n=this.cond.pretty(),o=this.elseBody===void 0?"":` else ${this.elseBody.pretty()}`;return`${r} (${n}) ${this.thenBody.pretty()}`+o}getSpan(){return this.span}};var Z=class e extends A{constructor(r){super();this.body=r}transform(r){return r(new e(this.body.transform(r)))}pretty(){return`loop ${this.body.pretty()}`}getSpan(){}};var Tt=class{constructor(t,r,n,o){this.name=t;this.args=r;this.body=n;this.span=o}pretty(){return`macro ${this.name}(${this.args.map(t=>t.pretty()).join(", ")}) ${this.body.pretty()}`}prettyHead(){return`macro ${this.name}(${this.args.map(t=>t.pretty()).join(", ")})`}};var w=class{constructor(){}};var N=class extends w{constructor(r){super();this.actions=r}transform(r){return r(this)}};var b=class e extends w{constructor(r){super();this.exprs=r}transform(r){return r(new e(this.exprs.map(n=>n.transform(r))))}};function dt(e){return e instanceof b&&e.exprs.every(t=>dt(t))}function St(e){if(e instanceof N)return e;if(e instanceof b&&e.exprs.length===1){let t=e.exprs[0];return St(t)}}var V=class e extends w{constructor(r,n,o){super();this.cond=r;this.thenBody=n;this.elseBody=o}transform(r){return r(new e(this.cond.transform(r),this.thenBody.transform(r),this.elseBody.transform(r)))}};var ht=class e extends w{constructor(r){super();this.body=r}kind="loop";transform(r){return r(new e(this.body.transform(r)))}};var xt=class e extends w{constructor(r,n,o){super();this.modifier=r;this.cond=n;this.body=o}transform(r){return r(new e(this.modifier,this.cond.transform(r),this.body.transform(r)))}};var X=class extends w{constructor(r,n){super();this.level=r;this.span=n}kind="break";transform(r){return r(this)}};var l=class e{static incU(t){return e.nonReturn(`INC U${t}`)}static incUMulti(...t){return new N([...t.map(r=>`INC U${r}`),"NOP"])}static tdecU(t){return e.single(`TDEC U${t}`)}static addA1(){return e.nonReturn("ADD A1")}static addB0(){return e.single("ADD B0")}static addB1(){return e.single("ADD B1")}static incB2DX(){return e.nonReturn("INC B2DX")}static tdecB2DX(){return e.single("TDEC B2DX")}static incB2DY(){return e.nonReturn("INC B2DY")}static tdecB2DY(){return e.single("TDEC B2DY")}static readB2D(){return e.single("READ B2D")}static setB2D(){return e.nonReturn("SET B2D")}static incB(t){return e.nonReturn(`INC B${t}`)}static tdecB(t){return e.single(`TDEC B${t}`)}static readB(t){return e.single(`READ B${t}`)}static setB(t){return e.nonReturn(`SET B${t}`)}static haltOUT(){return e.single("HALT_OUT")}static halt(){return e.single("HALT")}static mul0(){return e.single("MUL 0")}static mul1(){return e.single("MUL 1")}static nop(){return e.single("NOP")}static output(t){return e.nonReturn(`OUTPUT ${t}`)}static subA1(){return e.nonReturn("SUB A1")}static subB0(){return e.single("SUB B0")}static subB1(){return e.single("SUB B1")}static nonReturn(t){return new N([t,"NOP"])}static single(t){return new N([t])}};function wn(e,t){if(e.args.length!==0)throw new f(`"${e.name}" expects empty arguments${S(e.span?.start)}`,e.span);return t}function Ar(e,t){if(e.args.length!==1)throw new f(`number of arguments is not 1:"${e.name}"${S(e.span?.start)}`,e.span);let r=e.args[0];if(!(r instanceof U))throw new f(`argument is not a number: "${e.name}"${S(e.span?.start)}`,r.getSpan()??e.span);return t(r.value)}function Gn(e,t){if(e.args.length!==1)throw new f(`number of arguments is not 1: "${e.name}"${S(e.span?.start)}`,e.span);let r=e.args[0];if(!(r instanceof q))throw new f(`argument is not a string: "${e.name}"${S(e.span?.start)}`,r.getSpan()??e.span);return t(r.value)}var Jt=new Map([["nop",{expr:l.nop(),desc:"returns Z and does nothing else"}],["inc_b2dx",{expr:l.incB2DX(),desc:"increases the X position of the read head"}],["inc_b2dy",{expr:l.incB2DY(),desc:"increases the Y position of the read head"}],["tdec_b2dx",{expr:l.tdecB2DX(),desc:"returns Z if X read head is at least significant bit and NZ otherwise, and then decreases X position by 1 if NZ"}],["tdec_b2dy",{expr:l.tdecB2DY(),desc:"returns Z if Y read head is at least significant bit and NZ otherwise, and then decreases Y position by 1 if NZ"}],["read_b2d",{expr:l.readB2D(),desc:"returns the bit (Z = 0 or NZ = 1) at the read head, and then sets it equal to 0"}],["set_b2d",{expr:l.setB2D(),desc:"set the bit at the read head to 1, breaks if that bit already equals 1"}],["add_a1",{expr:l.addA1(),desc:"binary adder"}],["add_b0",{expr:l.addB0(),desc:"binary adder"}],["add_b1",{expr:l.addB1(),desc:"binary adder"}],["sub_a1",{expr:l.subA1(),desc:"binary subtractor"}],["sub_b0",{expr:l.subB0(),desc:"binary subtractor"}],["sub_b1",{expr:l.subB1(),desc:"binary subtractor"}],["mul_0",{expr:l.mul0(),desc:"binary multiplier"}],["mul_1",{expr:l.mul1(),desc:"binary multiplier"}],["halt_out",{expr:l.haltOUT(),desc:"halts the entire computation and emits a glider"}],["halt",{expr:l.halt(),desc:"halts the entire computation"}]]),Qt=new Map([["inc_u",{expr:l.incU,desc:"increases the value of the register by 1"}],["tdec_u",{expr:l.tdecU,desc:"returns Z if Un = 0 and NZ otherwise, and then decreases the value of the register by 1 if NZ"}],["inc_b",{expr:l.incB,desc:"increases the position of the read head"}],["tdec_b",{expr:l.tdecB,desc:"returns Z if read head is at least significant bit and NZ otherwise, and then decreases position by 1 if NZ"}],["read_b",{expr:l.readB,desc:"returns the bit (Z = 0 or NZ = 1) at the read head, and then sets it equal to 0"}],["set_b",{expr:l.setB,desc:"set the bit at the read head to 1, breaks if that bit already equals 1"}]]),te=new Map([["output",{expr:l.output,desc:"prints x in a font made up of blocks, x must be one of 0, 1, 2, 3, 4, 5, 6, 7, 8, 9, or."}]]);function Nn(e){let t=Jt.get(e.name);if(t!==void 0)return wn(e,t.expr);let r=Qt.get(e.name);if(r!==void 0)return Ar(e,r.expr);let n=te.get(e.name);if(n!==void 0)return Gn(e,n.expr);switch(e.name){case"break":return e.args.length===0?new X(void 0,e.span):Ar(e,o=>new X(o,e.span));case"repeat":{if(e.args.length!==2)throw new f(`"repeat" takes two arguments${S(e.span?.start)}`,e.span);let o=e.args[0];if(!(o instanceof U))throw new f(`first argument of "repeat" must be a number${S(e.span?.start)}`,o.getSpan()??e.span);let s=e.args[1];if(s===void 0)throw new Error("internal error");let i=ee(s);return new b(Array(o.value).fill(0).map(()=>i))}}throw new f(`Unknown ${e.name.endsWith("!")?"macro":"function"}: "${e.name}"${S(e.span?.start)}`,e.span)}function ee(e){let t=ee;if(e instanceof D)return Nn(e);if(e instanceof _)return e.modifier==="Z"?new V(t(e.cond),t(e.thenBody),e.elseBody===void 0?new b([]):t(e.elseBody)):new V(t(e.cond),e.elseBody===void 0?new b([]):t(e.elseBody),t(e.thenBody));if(e instanceof Z)return new ht(t(e.body));if(e instanceof U)throw new f(`number is not allowed: ${e.raw??e.value}${S(e.span?.start)}`,e.span);if(e instanceof K)return new b(e.exprs.map(r=>t(r)));if(e instanceof q)throw new f(`string is not allowed: ${e.pretty()}${S(e.span?.start)}`,e.span);if(e instanceof k)return new xt(e.modifier,t(e.cond),t(e.body));throw e instanceof z?new f(`macro variable is not allowed: variable "${e.name}"${S(e.span?.start)}`,e.span):Error("internal error")}var Dt=class{constructor(t,r,n){this.macros=t;this.headers=r;this.seqExpr=n}pretty(){return[this.macros.map(t=>t.pretty()).join(`
`),this.headers.map(t=>t.toString()).join(`
`),this.seqExpr.prettyInner()].join(`
`)}describeFunc(t){if(!(t instanceof D))return;let r=Jt.get(t.name);if(r!=null)return r.desc;let n=Qt.get(t.name);if(n!=null)return n.desc;let o=te.get(t.name);if(o!=null)return o.desc;if(t.name.endsWith("!")){let s=this.macros.find(i=>t.name===i.name);if(s)return s.prettyHead()}}};var $t=class{constructor(t,r){this.name=t;this.content=r}toString(){let t=this.content.startsWith(" ")?"":" ";return`#${this.name}${t}${this.content}`}};var U=class extends A{constructor(r,n,o){super();this.value=r;this.span=n;this.raw=o}transform(r){return r(this)}pretty(){return this.value.toString()}getSpan(){return this.span}};var q=class extends A{constructor(r,n){super();this.value=r;this.span=n}transform(r){return r(this)}pretty(){return'"'+this.value+'"'}getSpan(){return this.span}};var K=class e extends A{constructor(r){super();this.exprs=r}transform(r){return r(new e(this.exprs.map(n=>n.transform(r))))}pretty(){return`{${this.prettyInner()}}`}prettyInner(){return this.exprs.map(r=>r instanceof _||r instanceof Z||r instanceof k?r.pretty():r.pretty()+";").join(`
`)}getSpan(){}};var z=class extends A{constructor(r,n){super();this.name=r;this.span=n}transform(r){return r(this)}pretty(){return this.name}getSpan(){return this.span}};var k=class e extends A{constructor(r,n,o){super();this.modifier=r;this.cond=n;this.body=o}transform(r){return r(new e(this.modifier,this.cond.transform(r),this.body.transform(r)))}pretty(){return`while_${this.modifier==="Z"?"z":"nz"}(${this.cond.pretty()}) ${this.body.pretty()}`}getSpan(){}};function re(e,t,r){let n=e.split(/\r?\n/),o=n[t.line-2],s=n[t.line-1],i=n[t.line],c=" ".repeat(Math.max(0,t.column-1))+"^".repeat(r===void 0?1:Math.max(1,r.column-t.column)),a=o===void 0?[]:[o],u=i===void 0?[]:[i],x=" | ",E=t.line.toString(),d=" ".repeat(E.length);return[...a.map(y=>d+x+y),E+x+s,d+x+c,...u.map(y=>d+x+y)]}function Mn(e,t){let r=re(t,e.location);return[`Error: Parse error at line ${e.location.line} column ${e.location.column}:`,`  expected ${e.expected.join(", ")}`,"",...r].join(`
`)}function br(e,t){let r=e.parse(t);if(r.type==="ParseOK")return r.value;throw new f(Mn(r,t),{start:r.location,end:r.location})}function J(e,t){let r=t.length;return{start:e,end:{index:e.index+r-1,line:e.line,column:e.column+r}}}var Er=p.location.chain(e=>p.text('"').next(p.match(/[^"]*/)).skip(p.text('"')).desc(["string"]).map(t=>({value:t,span:J(e,`"${t}"`)})));var Bn=p.match(/\/\*(\*(?!\/)|[^*])*\*\//s).desc([]),g=p.match(/\s*/).desc(["space"]).sepBy(Bn).map(()=>{}),Ln=p.match(/\s+/).desc(["space"]),Tn=/[a-zA-Z_][a-zA-Z_0-9]*/u,Pr=p.match(Tn).desc(["identifier"]),Dn=Pr.wrap(g,g),$n=g.chain(()=>p.location.chain(e=>Pr.skip(g).map(t=>[t,J(e,t)]))),In=/[a-zA-Z_][a-zA-Z_0-9]*!/u,wr=p.match(In).wrap(g,g).desc(["macro name"]);function v(e){return p.text(e).wrap(g,g)}function Sr(e){return p.location.chain(r=>p.text(e).map(n=>[n,J(r,e)])).wrap(g,g)}var vn=v(",").desc(["`,`"]),Gr=v("(").desc(["`(`"]),Nr=v(")").desc(["`)`"]),On=v(";").desc(["`;`"]),Rn=v("{").desc(["`{`"]),Cn=v("}").desc(["`}`"]),Mr=$n.map(([e,t])=>new z(e,t));function Br(e){return p.lazy(()=>e()).sepBy(vn).wrap(Gr,Nr)}function _n(){return g.next(p.location).chain(e=>p.choice(wr,Dn).chain(t=>Br(()=>Q()).map(r=>new D(t,r,J(e,t)))))}var Zn=p.location.chain(e=>xr.map(t=>new U(t.value,J(e,t.raw),t.raw))).wrap(g,g),Un=Er.wrap(g,g).map(e=>new q(e.value,e.span)),Lr=p.lazy(()=>Xn()).repeat(),zn=Lr.wrap(Rn,Cn).map(e=>new K(e)),kn=p.choice(v("while_z"),v("while_nz")).map(e=>e==="while_z"?"Z":"NZ"),Tr=p.lazy(()=>Q()).wrap(Gr,Nr),Dr=kn.chain(e=>Tr.chain(t=>Q().map(r=>new k(e,t,r)))),$r=v("loop").next(p.lazy(()=>Q())).map(e=>new Z(e)),Fn=p.choice(Sr("if_z"),Sr("if_nz")).map(e=>e[0]==="if_z"?["Z",e[1]]:["NZ",e[1]]),Ir=Fn.chain(([e,t])=>Tr.chain(r=>p.lazy(()=>Q()).chain(n=>p.choice(v("else").next(p.lazy(()=>Q())),p.ok(void 0)).map(o=>new _(e,r,n,o,t))))),yr="macro",Wn=g.chain(e=>p.location.chain(t=>p.text(yr).next(Ln).map(r=>J(t,yr))));function Ce(){return Wn.and(wr).chain(([e,t])=>Br(()=>Mr).map(r=>({span:e,name:t,args:r})))}function Hn(){return Ce().chain(({span:e,name:t,args:r})=>p.lazy(()=>Q()).map(n=>new Tt(t,r,n,e)))}var Yn=p.match(/.*/),jn=p.text("#").next(p.match(/REGISTERS|COMPONENTS/)).desc(["#REGISTERS","#COMPONENTS"]).chain(e=>Yn.map(t=>new $t(e,t))),Vn=jn.wrap(g,g).repeat();function Q(){return p.choice($r,Dr,Ir,p.lazy(()=>_n()),zn,Mr,Zn,Un)}function Xn(){return p.choice($r,Dr,Ir,Q().skip(On))}function qn(){return Hn().repeat().chain(e=>Vn.chain(t=>Lr.wrap(g,g).map(r=>new Dt(e,t,new K(r)))))}function vr(e){return br(qn(),e)}function Kn(e){let t="",r=!1,n=0;for(;n<e.length;){let o=e[n],s=e[n+1];o==="/"&&s==="*"?(n+=2,r=!0):o==="*"&&s==="/"?(r=!1,n+=2):(r||(t+=o),n++)}return t}function Jn(e){let t=[],r=/(macro\s+([a-zA-Z_][a-zA-Z_0-9]*?!)\s*\(.*?\))/gs,n=Kn(e).matchAll(r);for(let o of n){let s=Ce().parse(o[0]);s.type==="ParseOK"&&t.push({name:s.value.name,args:s.value.args.map(i=>i.name)})}return t}function Or(e){return e.transform(Qn)}function Qn(e){return e instanceof b?eo(e):e}function Rr(e,t){let r=Cr(_e(e),_e(t));return r===void 0?void 0:_r(r)}var to=new T;function Cr(e,t){if(e.length===0)return t.slice();if(t.length===0)return e.slice();if(e.some(a=>a instanceof P)||t.some(a=>a instanceof P))return;let r=e.filter(a=>!(a instanceof T)),n=t.filter(a=>!(a instanceof T)),o=r.every(a=>!a.doesReturnValue()),s=n.every(a=>!a.doesReturnValue());if(!o&&!s||!r.every(a=>n.every(u=>!a.isSameComponent(u))))return;let c=r.concat(n);return o&&s&&c.push(to),c}function _e(e){return e.actions.flatMap(t=>{let r=pt(t);return r!==void 0?[r]:[]})}function _r(e){return new N(e.map(t=>t.pretty()))}function eo(e){let t=[],r=[],n=()=>{r.length!==0&&(t.push(_r(r)),r=[])};for(let o of e.exprs)if(o instanceof N){let s=_e(o),i=Cr(r,s);i===void 0?(n(),r=s):r=i}else n(),t.push(o);return n(),new b(t)}var L=class{constructor(t,r,n){this.input=t;this.output=r;this.inputZNZ=n}};function ro(e){let t=e.prevOutput,r=t;return(t==="*"||t==="Z")&&(r=" "+t),`${e.currentState}; ${r}; ${e.nextState}; ${e.actions.join(", ")}`}var $=class{constructor(t){this.inner=t;if(this.inner.actions.length===0)throw Error("actions must be nonempty")}},Ze=class{#i=0;#r=[];#n;#o;constructor(t={}){this.#n=t.prefix??"STATE_",this.#o=!(t.noOptimize??!1)}#e(){return this.#i++,`${this.#n}${this.#i}`}#s(t,r,n="*"){return new $({currentState:t,prevOutput:n,nextState:r,actions:["NOP"]})}transpile(t){let r="INITIAL",n=this.#e(),o=this.#s(r,n,"ZZ"),s=this.#n+"END",i=this.#t(new L(n,s,"*"),t),c=new $({currentState:s,prevOutput:"*",nextState:s,actions:["HALT"]});return[o,...i,c].map(a=>ro(a.inner))}#t(t,r){if(r instanceof N)return[this.#c(t,r)];if(r instanceof b)return this.#u(t,r);if(r instanceof V)return this.#m(t,r);if(r instanceof ht)return this.#f(t,r);if(r instanceof xt)return this.#d(t,r);if(r instanceof X)return this.#h(t,r);throw Error("unknown expr")}#c(t,r){return new $({currentState:t.input,prevOutput:t.inputZNZ,nextState:t.output,actions:r.actions})}#u(t,r){if(dt(r))return[this.#s(t.input,t.output,t.inputZNZ)];if(r.exprs.length===1){let i=r.exprs[0];if(i===void 0)throw new Error("internal error");return this.#t(t,i)}let n=[],o=t.input,s=r.exprs.length-1;for(let[i,c]of r.exprs.entries())if(i!==s){let a=this.#e();n=n.concat(this.#t(new L(o,a,i===0?t.inputZNZ:"*"),c)),o=a}else n=n.concat(this.#t(new L(o,t.output,"*"),c));return n}#m(t,r){if(this.#o&&dt(r.thenBody)&&dt(r.elseBody))return this.#t(t,r.cond);let n=this.#e(),o=this.#t(new L(t.input,n,t.inputZNZ),r.cond),[s,...i]=this.#t(new L(n,t.output,"Z"),r.thenBody),[c,...a]=this.#t(new L(n,t.output,"NZ"),r.elseBody);return[...o,s,c,...i,...a]}#f(t,r){let{startState:n,fromZOrNZ:o}=this.#a(t);this.#r.push(t.output);let s=this.#t(new L(n,n,"*"),r.body);return this.#r.pop(),[...o,...s]}#p(t,r,n,o){let{startState:s,fromZOrNZ:i}=this.#a(t),c=this.#e(),a=this.#c(new L(s,c,"*"),r),u=new $({currentState:c,prevOutput:"Z",nextState:o==="Z"?c:t.output,actions:o==="Z"?n.actions:["NOP"]}),x=new $({currentState:c,prevOutput:"NZ",nextState:o==="Z"?t.output:c,actions:o==="Z"?["NOP"]:n.actions});return[...i,a,u,x]}#l(t,r,n){let{startState:o,fromZOrNZ:s}=this.#a(t),i=this.#e(),c=this.#t(new L(o,i,"*"),r),a=new $({currentState:i,prevOutput:"Z",nextState:n==="Z"?o:t.output,actions:["NOP"]}),u=new $({currentState:i,prevOutput:"NZ",nextState:n==="Z"?t.output:o,actions:["NOP"]});return[...s,...c,a,u]}#d(t,r){let n=this.#o;if(n&&dt(r.body)){let y=St(r.cond);return y!==void 0?this.#p(t,y,y,r.modifier):this.#l(t,r.cond,r.modifier)}let o=St(r.body),s=St(r.cond);if(n&&s!==void 0&&o!==void 0){let y=Rr(o,s);if(y!==void 0)return this.#p(t,s,y,r.modifier)}let{startState:i,fromZOrNZ:c}=this.#a(t),a=this.#e(),u=this.#t(new L(i,a,"*"),r.cond),x=this.#e()+"_WHILE_BODY",E=new $({currentState:a,prevOutput:"Z",nextState:r.modifier==="Z"?x:t.output,actions:["NOP"]}),d=new $({currentState:a,prevOutput:"NZ",nextState:r.modifier==="Z"?t.output:x,actions:["NOP"]});this.#r.push(t.output);let M=this.#t(new L(x,i,"*"),r.body);return this.#r.pop(),[...c,...u,E,d,...M]}#a(t){let r=t.inputZNZ==="*"?t.input:this.#e(),n=t.inputZNZ==="*"?[]:[this.#s(t.input,r,t.inputZNZ)];return{startState:r,fromZOrNZ:n}}#h(t,r){let n=r.level??1;if(n<1)throw new f("break level is less than 1",r.span);let o=this.#r[this.#r.length-n];if(o===void 0)throw n===1?new f("break outside while or loop",r.span):new f("break level is greater than number of nests of while or loop",r.span);return[this.#s(t.input,o,t.inputZNZ)]}};function Ue(e,t={}){return new Ze(t).transpile(e)}function Zr(e){let t=new Set,r=[];for(let n of e)t.has(n)?r.push(n):t.add(n);return r}function Ur(e){return`${e} argument${e===1?"":"s"}`}function no(){throw new Error("internal error")}function oo(e,t){let r=t.args;if(r.length!==e.args.length)throw new f(`Error at "${e.name}": this macro takes ${Ur(e.args.length)} but ${Ur(r.length)} was supplied${S(t.span?.start)}`,t.span);let n=new Map(e.args.map((o,s)=>[o.name,r[s]??no()]));return e.body.transform(o=>{if(o instanceof z){let s=n.get(o.name);if(s===void 0)throw new f(`Error: Unknown variable "${o.name}"${S(o.span?.start)}`,o.span);return s}else return o})}var so=1e5,ze=class e{#i;#r=0;#n;constructor(t,r){this.#n=t,this.#i=r}static make(t){let r=new Map(t.macros.map(n=>[n.name,n]));if(r.size<t.macros.length){let o=Zr(t.macros.map(c=>c.name))[0],s=t.macros.slice().reverse().find(c=>c.name===o)?.span,i=s?.start;throw new f(`There is a macro with the same name: "${o}"`+S(i),s)}return new e(t,r)}expand(){return this.#o(this.#n.seqExpr)}#o(t){if(so<this.#r)throw Error("too many macro expansion");return this.#r++,t.transform(r=>this.#e(r))}#e(t){return t instanceof D?this.#s(t):t}#s(t){let r=this.#i.get(t.name);if(r!==void 0){let n=oo(r,t);return this.#o(n)}else return t}};function zr(e){return ze.make(e).expand()}function kr(e){return e.transform(io)}function io(e){return e instanceof b?ao(e):e}function ao(e){let t=[];for(let r of e.exprs)r instanceof b?t=t.concat(r.exprs):t.push(r);return new b(t)}function yt(e=void 0,t,...r){e&&console.log(e+" Start",performance.now());let n=t(...r);return e&&console.log(e+" End",performance.now()),n}function co(e,{log:t,noOptimize:r}){if(r===!0)return e;let n=yt(t?"optimize apgl seq":void 0,kr,e);return yt(t?"optimize apgl action":void 0,Or,n)}function Dm(e,t={}){let r=t.log??!1,n=yt(r?"apgm parse":void 0,vr,e);try{let o=yt(r?"apgm macro expand":void 0,zr,n),s=yt(r?"apgm to apgl":void 0,ee,o),i=co(s,{log:r,noOptimize:t.noOptimize}),c=yt(r?"apgl to apgsembly":void 0,Ue,i,t),a=["# State    Input    Next state    Actions","# ---------------------------------------"],x=n.headers.map(E=>E.toString()).concat(a,c);if(n.headers.every(E=>E.name!=="COMPONENTS"))try{let E=Re(c.join(`
`));E.length!==0&&x.unshift("#COMPONENTS "+E)}catch(E){console.error(E)}return x}catch(o){throw o instanceof f&&o.apgmSpan?new f([o.message,...re(e,o.apgmSpan.start,o.apgmSpan.end)].join(`
`),o.apgmSpan,{cause:o.cause}):o}}export{Jn as completionParser,Jt as emptyArgFuncs,hr as formatAPGsembly,Dm as integration,Qt as numArgFuncs,vr as parseMain,te as strArgFuncs};
