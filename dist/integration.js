var ar=Object.defineProperty;var cr=(e,t)=>{for(var r in t)ar(e,r,{get:t[r],enumerable:!0})};var a={};cr(a,{Parser:()=>P,all:()=>ge,choice:()=>mr,eof:()=>xe,fail:()=>ur,lazy:()=>lr,location:()=>_t,match:()=>fr,ok:()=>st,text:()=>pr});var P=class{constructor(e){this.action=e}parse(e){let t={index:0,line:1,column:1},r=new Ae({input:e,location:t}),n=this.skip(xe).action(r);return n.type==="ActionOK"?{type:"ParseOK",value:n.value}:{type:"ParseFail",location:n.furthest,expected:n.expected}}tryParse(e){let t=this.parse(e);if(t.type==="ParseOK")return t.value;let{expected:r,location:n}=t,{line:o,column:i}=n,c=`parse error at line ${o} column ${i}: expected ${r.join(", ")}`;throw new Error(c)}and(e){return new P(t=>{let r=this.action(t);if(r.type==="ActionFail")return r;t=t.moveTo(r.location);let n=t.merge(r,e.action(t));if(n.type==="ActionOK"){let o=[r.value,n.value];return t.merge(n,t.ok(n.location.index,o))}return n})}skip(e){return this.and(e).map(([t])=>t)}next(e){return this.and(e).map(([,t])=>t)}or(e){return new P(t=>{let r=this.action(t);return r.type==="ActionOK"?r:t.merge(r,e.action(t))})}chain(e){return new P(t=>{let r=this.action(t);if(r.type==="ActionFail")return r;let n=e(r.value);return t=t.moveTo(r.location),t.merge(r,n.action(t))})}map(e){return this.chain(t=>st(e(t)))}thru(e){return e(this)}desc(e){return new P(t=>{let r=this.action(t);return r.type==="ActionOK"?r:{type:"ActionFail",furthest:r.furthest,expected:e}})}wrap(e,t){return e.next(this).skip(t)}trim(e){return this.wrap(e,e)}repeat(e=0,t=1/0){if(!he(e,t))throw new Error(`repeat: bad range (${e} to ${t})`);return e===0?this.repeat(1,t).or(st([])):new P(r=>{let n=[],o=this.action(r);if(o.type==="ActionFail")return o;for(;o.type==="ActionOK"&&n.length<t;){if(n.push(o.value),o.location.index===r.location.index)throw new Error("infinite loop detected; don't call .repeat() with parsers that can accept zero characters");r=r.moveTo(o.location),o=r.merge(o,this.action(r))}return o.type==="ActionFail"&&n.length<e?o:r.merge(o,r.ok(r.location.index,n))})}sepBy(e,t=0,r=1/0){if(!he(t,r))throw new Error(`sepBy: bad range (${t} to ${r})`);return t===0?this.sepBy(e,1,r).or(st([])):r===1?this.map(n=>[n]):this.chain(n=>e.next(this).repeat(t-1,r-1).map(o=>[n,...o]))}node(e){return ge(_t,this,_t).map(([t,r,n])=>({type:"ParseNode",name:e,value:r,start:t,end:n}))}};function he(e,t){return e<=t&&e>=0&&t>=0&&Number.isInteger(e)&&e!==1/0&&(Number.isInteger(t)||t===1/0)}var _t=new P(e=>e.ok(e.location.index,e.location));function st(e){return new P(t=>t.ok(t.location.index,e))}function ur(e){return new P(t=>t.fail(t.location.index,e))}var xe=new P(e=>e.location.index<e.input.length?e.fail(e.location.index,["<EOF>"]):e.ok(e.location.index,"<EOF>"));function pr(e){return new P(t=>{let r=t.location.index,n=r+e.length;return t.input.slice(r,n)===e?t.ok(n,e):t.fail(r,[e])})}function fr(e){for(let r of e.flags)switch(r){case"i":case"s":case"m":case"u":continue;default:throw new Error("only the regexp flags 'imsu' are supported")}let t=new RegExp(e.source,e.flags+"y");return new P(r=>{let n=r.location.index;t.lastIndex=n;let o=r.input.match(t);if(o){let i=n+o[0].length,c=r.input.slice(n,i);return r.ok(i,c)}return r.fail(n,[String(e)])})}function ge(...e){return e.reduce((t,r)=>t.chain(n=>r.map(o=>[...n,o])),st([]))}function mr(...e){return e.reduce((t,r)=>t.or(r))}function lr(e){let t=new P(r=>(t.action=e().action,t.action(r)));return t}function dr(e,t){return[...new Set([...e,...t])]}var Ae=class{constructor(e){this.input=e.input,this.location=e.location}moveTo(e){return new Ae({input:this.input,location:e})}_internal_move(e){if(e===this.location.index)return this.location;let t=this.location.index,r=e,n=this.input.slice(t,r),{line:o,column:i}=this.location;for(let c of n)c===`
`?(o++,i=1):i++;return{index:e,line:o,column:i}}ok(e,t){return{type:"ActionOK",value:t,location:this._internal_move(e),furthest:{index:-1,line:-1,column:-1},expected:[]}}fail(e,t){return{type:"ActionFail",furthest:this._internal_move(e),expected:t}}merge(e,t){if(t.furthest.index>e.furthest.index)return t;let r=t.furthest.index===e.furthest.index?dr(e.expected,t.expected):e.expected;return t.type==="ActionOK"?{type:"ActionOK",location:t.location,value:t.value,furthest:e.furthest,expected:r}:{type:"ActionFail",furthest:e.furthest,expected:r}}};var f=class{pretty(){return"unimplemented"}doesReturnValue(){return!1}isSameComponent(t){return!0}};var At=0,bt=1,Et=2,Ct="A1",Zt="B0",zt="B1",be="ADD";function hr(e){switch(e){case At:return Ct;case bt:return Zt;case Et:return zt}}function xr(e){switch(e){case Ct:return At;case Zt:return bt;case zt:return Et}}var O=class extends f{constructor(t){super(),this.op=t}pretty(){return`${be} ${hr(this.op)}`}static parse(t){let r=t.trim().split(/\s+/u);if(r.length!==2)return;let[n,o]=r;if(n===be&&(o===Ct||o===Zt||o===zt))return new O(xr(o))}doesReturnValue(){switch(this.op){case At:return!1;case bt:return!0;case Et:return!0}}isSameComponent(t){return t instanceof O}};var Q=0,tt=1,at=2,ct=3,j=4,q=5,ut=6,yt="INC",Ut="TDEC",St="READ",Pt="SET",kt="B2DX",Ft="B2DY",Wt="B2D",gr="DEC",Ee="SQX",ye="SQY",Se="SQ";function Pe(e){switch(e){case yt:return Q;case Ut:return tt;case St:return at;case Pt:return ct}}function Ar(e){switch(e){case Q:return yt;case tt:return Ut;case at:return St;case ct:return Pt}}function we(e){switch(e){case kt:return j;case Ft:return q;case Wt:return ut}}function br(e){switch(e){case j:return kt;case q:return Ft;case ut:return Wt}}var A=class extends f{constructor(t,r){super(),this.op=t,this.axis=r}pretty(){return`${Ar(this.op)} ${br(this.axis)}`}static parse(t){let r=t.trim().split(/\s+/u);if(r.length!==2)return;let[n,o]=r;if(!(n===void 0||o===void 0)){if(n===yt||n===Ut){if(o===kt||o===Ft)return new A(Pe(n),we(o))}else if((n===St||n===Pt)&&o===Wt)return new A(Pe(n),we(o));switch(n){case yt:switch(o){case Ee:return new A(Q,j);case ye:return new A(Q,q);default:return}case gr:switch(o){case Ee:return new A(tt,j);case ye:return new A(tt,q);default:return}case St:switch(o){case Se:return new A(at,ut);default:return}case Pt:switch(o){case Se:return new A(ct,ut);default:return}}}}doesReturnValue(){switch(this.op){case Q:return!1;case tt:return!0;case at:return!0;case ct:return!1}}isSameComponent(t){if(t instanceof A){let r=this.axis,n=t.axis;return r===j&&n===q?!1:!(r===q&&n===j)}return!1}};var pt=0,ft=1,wt=2,Gt=3,Vt="INC",Yt="TDEC",Ht="READ",Xt="SET",Ge="B";function Er(e){switch(e){case pt:return Vt;case ft:return Yt;case wt:return Ht;case Gt:return Xt}}function yr(e){switch(e){case Vt:return pt;case Yt:return ft;case Ht:return wt;case Xt:return Gt}}var G=class extends f{constructor(t,r){super(),this.op=t,this.regNumber=r,this.registerCache=void 0}pretty(){return`${Er(this.op)} ${Ge}${this.regNumber}`}static parse(t){let r=t.trim().split(/\s+/u);if(r.length!==2)return;let[n,o]=r;if(!(n===void 0||o===void 0)&&(n===Vt||n===Yt||n===Ht||n===Xt)&&o.startsWith(Ge)){let i=o.slice(1);if(/^[0-9]+$/u.test(i))return new G(yr(n),parseInt(i,10))}}doesReturnValue(){switch(this.op){case pt:return!1;case ft:return!0;case wt:return!0;case Gt:return!1}}isSameComponent(t){return t instanceof G?this.regNumber===t.regNumber:!1}};var Ne="HALT_OUT",x=class extends f{constructor(){super()}pretty(){return Ne}static parse(t){let r=t.trim().split(/\s+/u);if(r.length!==1)return;let[n]=r;if(n===Ne)return new x}doesReturnValue(){return!1}isSameComponent(t){return t instanceof x}};var jt=0,qt=1,Kt="0",Jt="1",Me="MUL";function Sr(e){switch(e){case Kt:return jt;case Jt:return qt}}function Pr(e){switch(e){case jt:return Kt;case qt:return Jt}}var k=class extends f{constructor(t){super(),this.op=t}pretty(){return`${Me} ${Pr(this.op)}`}static parse(t){let r=t.trim().split(/\s+/u);if(r.length!==2)return;let[n,o]=r;if(n===Me&&(o===Kt||o===Jt))return new k(Sr(o))}doesReturnValue(){return!0}isSameComponent(t){return t instanceof k}};var Le="NOP",b=class extends f{constructor(){super()}pretty(){return Le}static parse(t){let r=t.trim().split(/\s+/u);if(r.length!==1)return;let[n]=r;if(n===Le)return new b}doesReturnValue(){return!0}isSameComponent(t){return t instanceof b}};var Be="OUTPUT",F=class extends f{constructor(t){super(),this.digit=t}pretty(){return`${Be} ${this.digit}`}static parse(t){let r=t.trim().split(/\s+/u);if(r.length!==2)return;let[n,o]=r;if(n===Be&&o!==void 0)return new F(o)}doesReturnValue(){return!1}isSameComponent(t){return t instanceof F}};var Nt=0,Mt=1,Lt=2,Qt="A1",te="B0",ee="B1",Te="SUB";function wr(e){switch(e){case Nt:return Qt;case Mt:return te;case Lt:return ee}}function Gr(e){switch(e){case Qt:return Nt;case te:return Mt;case ee:return Lt}}var W=class extends f{constructor(t){super(),this.op=t}pretty(){return`${Te} ${wr(this.op)}`}static parse(t){let r=t.trim().split(/\s+/u);if(r.length!==2)return;let[n,o]=r;if(n===Te&&(o===Qt||o===te||o===ee))return new W(Gr(o))}doesReturnValue(){switch(this.op){case Nt:return!1;case Mt:return!0;case Lt:return!0}}isSameComponent(t){return t instanceof W}};var Bt=0,mt=1,re="INC",ne="TDEC",$e="U",Nr="R";function Mr(e){switch(e){case Bt:return re;case mt:return ne}}function Lr(e){switch(e){case re:return Bt;case ne:return mt}}var N=class extends f{constructor(t,r){super(),this.op=t,this.regNumber=r,this.registerCache=void 0}pretty(){return`${Mr(this.op)} ${$e}${this.regNumber}`}static parse(t){let r=t.trim().split(/\s+/u);if(r.length!==2)return;let[n,o]=r;if(!(n===void 0||o===void 0)&&(n===re||n===ne)&&(o.startsWith($e)||o.startsWith(Nr))){let i=o.slice(1);if(/^[0-9]+$/u.test(i))return new N(Lr(n),parseInt(i,10))}}doesReturnValue(){switch(this.op){case Bt:return!1;case mt:return!0}}isSameComponent(t){return t instanceof N?this.regNumber===t.regNumber:!1}};var Tt=0,$t=1,vt=2,Rt=3,It=4,oe="INC",ie="DEC",se="READ",ae="SET",ce="RESET";function Br(e){switch(e){case Tt:return oe;case $t:return ie;case vt:return se;case Rt:return ae;case It:return ce}}function Tr(e){switch(e){case oe:return Tt;case ie:return $t;case se:return vt;case ae:return Rt;case ce:return It}}var _=class extends f{constructor(t,r){super(),this.op=t,this.regNumber=r}pretty(){return`${Br(this.op)} T${this.regNumber}`}static parse(t){let r=t.trim().split(/\s+/u);if(r.length!==2)return;let[n,o]=r;if(!(n===void 0||o===void 0)&&(n===oe||n===ie||n===se||n===ae||n===ce)&&o.startsWith("T")){let i=o.slice(1);if(/^[0-9]+$/u.test(i))return new _(Tr(n),parseInt(i,10))}}doesReturnValue(){switch(this.op){case Tt:return!0;case $t:return!0;case vt:return!0;case Rt:return!1;case It:return!1}}isSameComponent(t){return t instanceof _?this.regNumber===t.regNumber:!1}};function et(e){let t=[G.parse,N.parse,A.parse,b.parse,O.parse,k.parse,W.parse,F.parse,x.parse,_.parse];for(let r of t){let n=r(e);if(n!==void 0)return n}}var Ti=Number.parseInt,$i=Number.isNaN;var Ir=a.match(/[0-9]+/).desc(["number"]).map(e=>({raw:e,value:parseInt(e,10)})),Dr=a.match(/0x[a-fA-F0-9]+/).desc(["hexadecimal number"]).map(e=>({raw:e,value:parseInt(e,16)})),ve=Dr.or(Ir).desc(["number"]);var h=class{constructor(){}},p=class extends Error{constructor(r,n,o){super(r,o);this.apgmSpan=n}};function Re(e){return`line ${e.line} column ${e.column}`}function g(e){return e!==void 0?` at ${Re(e)}`:""}var M=class extends h{constructor(r,n,o){super();this.name=r;this.args=n;this.span=o}transform(r){return r(new M(this.name,this.args.map(n=>n.transform(r)),this.span))}pretty(){return`${this.name}(${this.args.map(r=>r.pretty()).join(", ")})`}};var L=class extends h{constructor(r,n,o,i,c){super();this.modifier=r;this.cond=n;this.thenBody=o;this.elseBody=i;this.span=c}transform(r){return r(new L(this.modifier,this.cond.transform(r),this.thenBody.transform(r),this.elseBody!==void 0?this.elseBody.transform(r):void 0,this.span))}pretty(){let r=`if_${this.modifier==="Z"?"z":"nz"}`,n=this.cond.pretty(),o=this.elseBody===void 0?"":` else ${this.elseBody.pretty()}`;return`${r} (${n}) ${this.thenBody.pretty()}`+o}};var B=class extends h{constructor(r){super();this.body=r}transform(r){return r(new B(this.body.transform(r)))}pretty(){return`loop ${this.body.pretty()}`}};var ht=class{constructor(t,r,n,o){this.name=t;this.args=r;this.body=n;this.span=o}pretty(){return`macro ${this.name}(${this.args.map(t=>t.pretty()).join(", ")}) ${this.body.pretty()}`}};var xt=class{constructor(t,r,n){this.macros=t;this.headers=r;this.seqExpr=n}pretty(){return[this.macros.map(t=>t.pretty()).join(`
`),this.headers.map(t=>t.toString()).join(`
`),this.seqExpr.prettyInner()].join(`
`)}};var gt=class{constructor(t,r){this.name=t;this.content=r}toString(){let t=this.content.startsWith(" ")?"":" ";return`#${this.name}${t}${this.content}`}};var C=class extends h{constructor(r,n,o){super();this.value=r;this.span=n;this.raw=o}transform(r){return r(this)}pretty(){return this.value.toString()}};var V=class extends h{constructor(r,n){super();this.value=r;this.span=n}transform(r){return r(this)}pretty(){return'"'+this.value+'"'}};var R=class extends h{constructor(r){super();this.exprs=r}transform(r){return r(new R(this.exprs.map(n=>n.transform(r))))}pretty(){return`{${this.prettyInner()}}`}prettyInner(){return this.exprs.map(r=>r instanceof L||r instanceof B||r instanceof T?r.pretty():r.pretty()+";").join(`
`)}};var Z=class extends h{constructor(r,n){super();this.name=r;this.span=n}transform(r){return r(this)}pretty(){return this.name}};var T=class extends h{constructor(r,n,o){super();this.modifier=r;this.cond=n;this.body=o}transform(r){return r(new T(this.modifier,this.cond.transform(r),this.body.transform(r)))}pretty(){return`while_${this.modifier==="Z"?"z":"nz"}(${this.cond.pretty()}) ${this.body.pretty()}`}};function Dt(e,t){let r=t.split(/\r?\n/),n=r[e.line-2],o=r[e.line-1],i=r[e.line],c=" ".repeat(Math.max(0,e.column-1))+"^",m=n===void 0?[]:[n],u=i===void 0?[]:[i],S=" | ",v=e.line.toString(),ot=" ".repeat(v.length);return[...m.map(it=>ot+S+it),v+S+o,ot+S+c,...u.map(it=>ot+S+it)]}function Or(e,t){let r=Dt(e.location,t);return[`parse error at line ${e.location.line} column ${e.location.column}:`,`  expected ${e.expected.join(", ")}`,"",...r].join(`
`)}function Ie(e,t){let r=e.parse(t);if(r.type==="ParseOK")return r.value;throw new p(Or(r,t),{start:r.location,end:r.location})}function Y(e,t){let r=t.length;return{start:e,end:{index:e.index+r-1,line:e.line,column:e.column+r}}}var De=a.location.chain(e=>a.text('"').next(a.match(/[^"]*/)).skip(a.text('"')).desc(["string"]).map(t=>({value:t,span:Y(e,`"${t}"`)})));var _r=a.match(/\/\*(\*(?!\/)|[^*])*\*\//s).desc([]),d=a.match(/\s*/).desc(["space"]).sepBy(_r).map(()=>{}),Cr=a.match(/\s+/).desc(["space"]),Zr=/[a-zA-Z_][a-zA-Z_0-9]*/u,_e=a.match(Zr).desc(["identifier"]),zr=_e.wrap(d,d),Ur=d.chain(()=>a.location.chain(e=>_e.skip(d).map(t=>[t,Y(e,t)]))),kr=/[a-zA-Z_][a-zA-Z_0-9]*!/u,Ce=a.match(kr).wrap(d,d).desc(["macro name"]);function I(e){return a.text(e).wrap(d,d)}function Oe(e){return a.location.chain(r=>a.text(e).map(n=>[n,Y(r,e)])).wrap(d,d)}var Fr=I(",").desc(["`,`"]),Ze=I("(").desc(["`(`"]),ze=I(")").desc(["`)`"]),Wr=I(";").desc(["`;`"]),Vr=I("{").desc(["`{`"]),Yr=I("}").desc(["`}`"]),Ue=Ur.map(([e,t])=>new Z(e,t));function ke(e){return a.lazy(()=>e()).sepBy(Fr).wrap(Ze,ze)}function Hr(){return d.next(a.location).chain(e=>a.choice(Ce,zr).chain(t=>ke(()=>H()).map(r=>new M(t,r,Y(e,t)))))}var Xr=a.location.chain(e=>ve.map(t=>new C(t.value,Y(e,t.raw),t.raw))).wrap(d,d),jr=De.wrap(d,d).map(e=>new V(e.value,e.span)),Fe=a.lazy(()=>nn()).repeat(),qr=Fe.wrap(Vr,Yr).map(e=>new R(e)),Kr=a.choice(I("while_z"),I("while_nz")).map(e=>e==="while_z"?"Z":"NZ"),We=a.lazy(()=>H()).wrap(Ze,ze),Ve=Kr.chain(e=>We.chain(t=>H().map(r=>new T(e,t,r)))),Ye=I("loop").next(a.lazy(()=>H())).map(e=>new B(e)),Jr=a.choice(Oe("if_z"),Oe("if_nz")).map(e=>e[0]==="if_z"?["Z",e[1]]:["NZ",e[1]]);function He(){return Jr.chain(([e,t])=>We.chain(r=>a.lazy(()=>H()).chain(n=>a.choice(I("else").next(a.lazy(()=>H())),a.ok(void 0)).map(o=>new L(e,r,n,o,t)))))}function ue(){let e="macro";return d.chain(r=>a.location.chain(n=>a.text(e).next(Cr).map(o=>Y(n,e)))).and(Ce).chain(([r,n])=>ke(()=>Ue).map(o=>({span:r,name:n,args:o})))}function Qr(){return ue().chain(({span:e,name:t,args:r})=>a.lazy(()=>H()).map(n=>new ht(t,r,n,e)))}var tn=a.match(/.*/),en=a.text("#").next(a.match(/REGISTERS|COMPONENTS/)).desc(["#REGISTERS","#COMPONENTS"]).chain(e=>tn.map(t=>new gt(e,t))),rn=en.wrap(d,d).repeat();function H(){return a.choice(Ye,Ve,a.lazy(()=>He()),a.lazy(()=>Hr()),qr,Ue,Xr,jr)}function nn(){return a.choice(Ye,Ve,He(),H().skip(Wr))}function on(){return Qr().repeat().chain(e=>rn.chain(t=>Fe.wrap(d,d).map(r=>new xt(e,t,new R(r)))))}function Xe(e){return Ie(on(),e)}var E=class{constructor(){}};var y=class extends E{constructor(r){super();this.actions=r}transform(r){return r(this)}};var l=class extends E{constructor(r){super();this.exprs=r}transform(r){return r(new l(this.exprs.map(n=>n.transform(r))))}};function K(e){return e instanceof l&&e.exprs.every(t=>K(t))}function rt(e){if(e instanceof y)return e;if(e instanceof l&&e.exprs.length===1){let t=e.exprs[0];return rt(t)}}var D=class extends E{constructor(r,n,o){super();this.cond=r;this.thenBody=n;this.elseBody=o}transform(r){return r(new D(this.cond.transform(r),this.thenBody.transform(r),this.elseBody.transform(r)))}};var z=class extends E{constructor(r){super();this.body=r;this.kind="loop"}transform(r){return r(new z(this.body.transform(r)))}};var U=class extends E{constructor(r,n,o){super();this.modifier=r;this.cond=n;this.body=o}transform(r){return r(new U(this.modifier,this.cond.transform(r),this.body.transform(r)))}};var X=class extends E{constructor(r,n){super();this.level=r;this.span=n;this.kind="break"}transform(r){return r(this)}};var s=class{static incU(t){return s.nonReturn(`INC U${t}`)}static incUMulti(...t){return new y([...t.map(r=>`INC U${r}`),"NOP"])}static tdecU(t){return s.single(`TDEC U${t}`)}static addA1(){return s.nonReturn("ADD A1")}static addB0(){return s.single("ADD B0")}static addB1(){return s.single("ADD B1")}static incB2DX(){return s.nonReturn("INC B2DX")}static tdecB2DX(){return s.single("TDEC B2DX")}static incB2DY(){return s.nonReturn("INC B2DY")}static tdecB2DY(){return s.single("TDEC B2DY")}static readB2D(){return s.single("READ B2D")}static setB2D(){return s.nonReturn("SET B2D")}static incB(t){return s.nonReturn(`INC B${t}`)}static tdecB(t){return s.single(`TDEC B${t}`)}static readB(t){return s.single(`READ B${t}`)}static setB(t){return s.nonReturn(`SET B${t}`)}static haltOUT(){return s.single("HALT_OUT")}static mul0(){return s.single("MUL 0")}static mul1(){return s.single("MUL 1")}static nop(){return s.single("NOP")}static output(t){return s.nonReturn(`OUTPUT ${t}`)}static subA1(){return s.nonReturn("SUB A1")}static subB0(){return s.single("SUB B0")}static subB1(){return s.single("SUB B1")}static nonReturn(t){return new y([t,"NOP"])}static single(t){return new y([t])}};function sn(e,t){if(e.args.length!==0)throw new p(`"${e.name}" expects empty argments${g(e.span?.start)}`,e.span);return t}function je(e,t){if(e.args.length!==1)throw new p(`number of arguments is not 1: "${e.name}"${g(e.span?.start)}`,e.span);let r=e.args[0];if(!(r instanceof C))throw new p(`argument is not a number: "${e.name}"${g(e.span?.start)}`,e.span);return t(r.value)}function an(e,t){if(e.args.length!==1)throw new p(`number of arguments is not 1: "${e.name}"${g(e.span?.start)}`,e.span);let r=e.args[0];if(!(r instanceof V))throw new p(`argument is not a string: "${e.name}"${g(e.span?.start)}`,e.span);return t(r.value)}var qe=new Map([["nop",s.nop()],["inc_b2dx",s.incB2DX()],["inc_b2dy",s.incB2DY()],["tdec_b2dx",s.tdecB2DX()],["tdec_b2dy",s.tdecB2DY()],["read_b2d",s.readB2D()],["set_b2d",s.setB2D()],["add_a1",s.addA1()],["add_b0",s.addB0()],["add_b1",s.addB1()],["sub_a1",s.subA1()],["sub_b0",s.subB0()],["sub_b1",s.subB1()],["mul_0",s.mul0()],["mul_1",s.mul1()],["halt_out",s.haltOUT()]]),Ke=new Map([["inc_u",s.incU],["tdec_u",s.tdecU],["inc_b",s.incB],["tdec_b",s.tdecB],["read_b",s.readB],["set_b",s.setB]]),Je=new Map([["output",s.output]]);function cn(e){let t=qe.get(e.name);if(t!==void 0)return sn(e,t);let r=Ke.get(e.name);if(r!==void 0)return je(e,r);let n=Je.get(e.name);if(n!==void 0)return an(e,n);switch(e.name){case"break":return e.args.length===0?new X(void 0,e.span):je(e,o=>new X(o,e.span));case"repeat":{if(e.args.length!==2)throw new p(`"repeat" takes two arguments${g(e.span?.start)}`,e.span);let o=e.args[0];if(!(o instanceof C))throw new p(`first argument of "repeat" must be a number${g(e.span?.start)}`,e.span);let i=e.args[1];if(i===void 0)throw new Error("internal error");let c=Ot(i);return new l(Array(o.value).fill(0).map(()=>c))}}throw new p(`Unknown ${e.name.endsWith("!")?"macro":"function"}: "${e.name}"${g(e.span?.start)}`,e.span)}function Ot(e){let t=Ot;if(e instanceof M)return cn(e);if(e instanceof L)return e.modifier==="Z"?new D(t(e.cond),t(e.thenBody),e.elseBody===void 0?new l([]):t(e.elseBody)):new D(t(e.cond),e.elseBody===void 0?new l([]):t(e.elseBody),t(e.thenBody));if(e instanceof B)return new z(t(e.body));if(e instanceof C)throw new p(`number is not allowed: ${e.raw??e.value}${g(e.span?.start)}`,e.span);if(e instanceof R)return new l(e.exprs.map(r=>t(r)));if(e instanceof V)throw new p(`string is not allowed: ${e.pretty()}${g(e.span?.start)}`,e.span);if(e instanceof T)return new U(e.modifier,t(e.cond),t(e.body));throw e instanceof Z?new p(`macro variable is not allowed: variable "${e.name}"${g(e.span?.start)}`,e.span):Error("internal error")}function un(e){let t="",r=!1,n=0;for(;n<e.length;){let o=e[n],i=e[n+1];o==="/"&&i==="*"?(n+=2,r=!0):o==="*"&&i==="/"?(r=!1,n+=2):(r||(t+=o),n++)}return t}function pn(e){let t=[],r=/(macro\s+([a-zA-Z_][a-zA-Z_0-9]*?!)\s*\(.*?\))/gs,n=un(e).matchAll(r);for(let o of n){let i=ue().parse(o[0]);i.type==="ParseOK"&&t.push({name:i.value.name,args:i.value.args.map(c=>c.name)})}return t}function Qe(e){return e.transform(fn)}function fn(e){return e instanceof l?mn(e):e}function tr(e,t){let r=er(pe(e),pe(t));return r===void 0?void 0:rr(r)}function er(e,t){if(e.length===0)return t.slice();if(t.length===0)return e.slice();if(e.some(u=>u instanceof x)||t.some(u=>u instanceof x))return;let r=e.filter(u=>!(u instanceof b)),n=t.filter(u=>!(u instanceof b)),o=r.every(u=>!u.doesReturnValue()),i=n.every(u=>!u.doesReturnValue());if(!o&&!i||!r.every(u=>n.every(S=>!u.isSameComponent(S))))return;let m=r.concat(n);return o&&i&&m.push(new b),m}function pe(e){return e.actions.flatMap(t=>{let r=et(t);return r!==void 0?[r]:[]})}function rr(e){return new y(e.map(t=>t.pretty()))}function mn(e){let t=[],r=[],n=()=>{r.length!==0&&(t.push(rr(r)),r=[])};for(let o of e.exprs)if(o instanceof y){let i=pe(o),c=er(r,i);c===void 0?(n(),r=i):r=c}else n(),t.push(o);return n(),new l(t)}var w=class{constructor(t,r,n){this.input=t;this.output=r;this.inputZNZ=n}},$=class{constructor(t){this.inner=t;if(this.inner.actions.length===0)throw Error("actions must be nonempty")}toLineString(){let t=this.inner,r=t.prevOutput,n=r;return(r==="*"||r==="Z")&&(n=" "+r),`${t.currentState}; ${n}; ${t.nextState}; ${t.actions.join(", ")}`}},fe=class{#e=0;#t=[];#r;#n;constructor(t={}){this.#r=t.prefix??"STATE_",this.#n=!(t.noOptimize??!1)}getFreshName(){return this.#e++,`${this.#r}${this.#e}`}createTransition(t,r,n="*"){return new $({currentState:t,prevOutput:n,nextState:r,actions:["NOP"]})}transpile(t){let r="INITIAL",n=this.getFreshName()+"_INITIAL",o=this.createTransition(r,n,"ZZ"),i=this.#r+"END",c=this.transpileExpr(new w(n,i,"*"),t),m=new $({currentState:i,prevOutput:"*",nextState:i,actions:["HALT_OUT"]});return[o,...c,m].map(u=>u.toLineString())}transpileExpr(t,r){if(r instanceof y)return[this.#o(t,r)];if(r instanceof l)return this.#a(t,r);if(r instanceof D)return this.#c(t,r);if(r instanceof z)return this.#u(t,r);if(r instanceof U)return this.#f(t,r);if(r instanceof X)return this.#m(t,r);throw Error("unknown expr")}#o(t,r){return new $({currentState:t.input,prevOutput:t.inputZNZ,nextState:t.output,actions:r.actions})}#a(t,r){if(K(r))return[this.createTransition(t.input,t.output,t.inputZNZ)];if(r.exprs.length===1){let c=r.exprs[0];if(c===void 0)throw new Error("internal error");return this.transpileExpr(t,c)}let n=[],o=t.input,i=r.exprs.length-1;for(let[c,m]of r.exprs.entries())if(c===i)n=n.concat(this.transpileExpr(new w(o,t.output,"*"),m));else{let u=this.getFreshName();n=n.concat(this.transpileExpr(new w(o,u,c===0?t.inputZNZ:"*"),m)),o=u}return n}#c(t,r){if(this.#n&&K(r.thenBody)&&K(r.elseBody))return this.transpileExpr(t,r.cond);let n=this.getFreshName(),o=this.transpileExpr(new w(t.input,n,t.inputZNZ),r.cond),[i,...c]=this.transpileExpr(new w(n,t.output,"Z"),r.thenBody),[m,...u]=this.transpileExpr(new w(n,t.output,"NZ"),r.elseBody);return[...o,i,m,...c,...u]}#u(t,r){let{startState:n,fromZOrNZ:o}=this.#i(t);this.#t.push(t.output);let i=this.transpileExpr(new w(n,n,"*"),r.body);return this.#t.pop(),[...o,...i]}#s(t,r,n,o){let{startState:i,fromZOrNZ:c}=this.#i(t),m=this.getFreshName(),u=this.#o(new w(i,m,"*"),r),S=new $({currentState:m,prevOutput:"Z",nextState:o==="Z"?m:t.output,actions:o==="Z"?n.actions:["NOP"]}),v=new $({currentState:m,prevOutput:"NZ",nextState:o==="Z"?t.output:m,actions:o==="Z"?["NOP"]:n.actions});return[...c,u,S,v]}#p(t,r,n){let{startState:o,fromZOrNZ:i}=this.#i(t),c=this.getFreshName(),m=this.transpileExpr(new w(o,c,"*"),r),u=new $({currentState:c,prevOutput:"Z",nextState:n==="Z"?o:t.output,actions:["NOP"]}),S=new $({currentState:c,prevOutput:"NZ",nextState:n==="Z"?t.output:o,actions:["NOP"]});return[...i,...m,u,S]}#f(t,r){let n=this.#n;if(n&&K(r.body)){let J=rt(r.cond);return J!==void 0?this.#s(t,J,J,r.modifier):this.#p(t,r.cond,r.modifier)}let o=rt(r.body),i=rt(r.cond);if(n&&i!==void 0&&o!==void 0){let J=tr(o,i);if(J!==void 0)return this.#s(t,i,J,r.modifier)}let{startState:c,fromZOrNZ:m}=this.#i(t),u=this.getFreshName(),S=this.transpileExpr(new w(c,u,"*"),r.cond),v=this.getFreshName()+"_WHILE_BODY",ot=new $({currentState:u,prevOutput:"Z",nextState:r.modifier==="Z"?v:t.output,actions:["NOP"]}),de=new $({currentState:u,prevOutput:"NZ",nextState:r.modifier==="Z"?t.output:v,actions:["NOP"]});this.#t.push(t.output);let it=this.transpileExpr(new w(v,c,"*"),r.body);return this.#t.pop(),[...m,...S,ot,de,...it]}#i(t){let r=t.inputZNZ==="*"?t.input:this.getFreshName(),n=t.inputZNZ==="*"?[]:[this.createTransition(t.input,r,t.inputZNZ)];return{startState:r,fromZOrNZ:n}}#m(t,r){let n=r.level??1;if(n<1)throw new p("break level is less than 1",r.span);let o=this.#t[this.#t.length-n];if(o===void 0)throw n===1?new p("break outside while or loop",r.span):new p("break level is greater than number of nests of while or loop",r.span);return[this.createTransition(t.input,o,t.inputZNZ)]}};function me(e,t={}){return new fe(t).transpile(e)}function nr(e){let t=new Set,r=[];for(let n of e)t.has(n)?r.push(n):t.add(n);return r}function or(e){return`${e} argument${e===1?"":"s"}`}function ln(){throw new Error("internal error")}function dn(e,t){let r=t.args;if(r.length!==e.args.length)throw new p(`argument length mismatch: "${e.name}" expect ${or(e.args.length)} but given ${or(r.length)}${g(t.span?.start)}`,t.span);let n=new Map(e.args.map((o,i)=>[o.name,r[i]??ln()]));return e.body.transform(o=>{if(o instanceof Z){let i=n.get(o.name);if(i===void 0)throw new p(`scope error: Unknown variable "${o.name}"${g(o.span?.start)}`,o.span);return i}else return o})}var hn=1e5,le=class{constructor(t){this.#t=0;if(this.main=t,this.#e=new Map(t.macros.map(r=>[r.name,r])),this.#e.size<t.macros.length){let n=nr(t.macros.map(c=>c.name))[0],o=t.macros.slice().reverse().find(c=>c.name===n)?.span,i=o?.start;throw new p(`There is a macro with the same name: "${n}"`+g(i),o)}}#e;#t;expand(){return this.#r(this.main.seqExpr)}#r(t){if(hn<this.#t)throw Error("too many macro expansion");return this.#t++,t.transform(r=>this.#n(r))}#n(t){return t instanceof M?this.#o(t):t}#o(t){let r=this.#e.get(t.name);if(r!==void 0){let n=dn(r,t);return this.#r(n)}else return t}};function ir(e){return new le(e).expand()}function sr(e){return e.transform(xn)}function xn(e){return e instanceof l?gn(e):e}function gn(e){let t=[];for(let r of e.exprs)r instanceof l?t=t.concat(r.exprs):t.push(r);return new l(t)}function nt(e=void 0,t,...r){e&&console.log(e+" Start",performance.now());let n=t(...r);return e&&console.log(e+" End",performance.now()),n}function An(e,{log:t,noOptimize:r}){if(r===!0)return e;let n=nt(t?"optimize apgl seq":void 0,sr,e);return nt(t?"optimize apgl action":void 0,Qe,n)}function Ju(e,t={}){let r=t.log??!1,n=nt(r?"apgm parse":void 0,Xe,e);try{let o=nt(r?"apgm macro expaned":void 0,ir,n),i=nt(r?"apgm to apgl":void 0,Ot,o),c=An(i,{log:r,noOptimize:t.noOptimize}),m=nt(r?"apgl to apgsembly":void 0,me,c,t),u=["# State    Input    Next state    Actions","# ---------------------------------------"];return n.headers.map(v=>v.toString()).concat(u,m)}catch(o){throw o instanceof p&&o.apgmSpan?new p([o.message,...Dt(o.apgmSpan.start,e)].join(`
`),o.apgmSpan,{cause:o.cause}):o}}export{pn as completionParser,qe as emptyArgFuncs,Ju as integration,Ke as numArgFuncs,Je as strArgFuncs};
